<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=600, initial-scale=1">
    <title>Packaging Old-Style SPKGs &mdash; Sage Developer&#39;s Guide v7.5</title>
    
    <link rel="stylesheet" href="_static/sage.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '7.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <script type="text/javascript" src="_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <script type="text/javascript" src="_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Sage Developer&#39;s Guide v7.5" href="index.html" />
    <link rel="next" title="Sage Notebook Developer Guide" href="sagenb/index.html" />
    <link rel="prev" title="Packaging Third-Party Code" href="packaging.html" />
    <link rel="icon" href="_static/sageicon.png" type="image/x-icon" />
    <script src="_static/thebe.js" type="text/javascript"></script>
    <script src="_static/thebe-sage.js" type="text/javascript"></script>

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="sagenb/index.html" title="Sage Notebook Developer Guide"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="packaging.html" title="Packaging Third-Party Code"
             accesskey="P">previous</a> |</li>
  
    
      <a href="../index.html"><img src="_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li class="nav-item nav-item-0"><a href="index.html">Developer&#39;s Guide v7.5</a> &raquo;</li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="packaging-old-style-spkgs">
<span id="chapter-old-spkg"></span><h1>Packaging Old-Style SPKGs<a class="headerlink" href="#packaging-old-style-spkgs" title="Permalink to this headline">¶</a></h1>
<p>This chapter explains old-style spkgs; It applies only to legacy
optional spkgs and experimental spkgs.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Old-style packages are <strong>deprecated</strong>, it is strongly
suggested that you make a new-style package instead.
See <a class="reference internal" href="packaging.html#chapter-packaging"><span class="std std-ref">Packaging Third-Party Code</span></a>
for the modern way of packaging third-party software.</p>
</div>
<div class="section" id="creating-an-old-style-spkg">
<h2>Creating an Old-Style SPKG<a class="headerlink" href="#creating-an-old-style-spkg" title="Permalink to this headline">¶</a></h2>
<p>If you are producing code to add new functionality to Sage, you might
consider turning it into a package (an &#8220;spkg&#8221;) instead of a patch
file. If your code is very large (for instance) and should be offered
as an optional download, a package is the right choice. Similarly, if
your code depends on some other optional component of Sage, you should
produce a package. When in doubt, ask for advice on the <code class="docutils literal"><span class="pre">sage-devel</span></code>
mailing list.</p>
<p>The abbreviation &#8220;spkg&#8221; stands for &#8220;Sage package&#8221;. The directory
<code class="docutils literal"><span class="pre">SAGE_ROOT/spkg/standard</span></code> contains spkg&#8217;s. In a source install,
these are all Sage spkg files (actually <code class="docutils literal"><span class="pre">.tar</span></code> or <code class="docutils literal"><span class="pre">.tar.bz2</span></code>
files), which are the source code that defines Sage. In a binary
install, some of these may be small placeholder files to save space.</p>
<p>Sage packages are distributed as <code class="docutils literal"><span class="pre">.spkg</span></code> files, which are
<code class="docutils literal"><span class="pre">.tar.bz2</span></code> files (or <code class="docutils literal"><span class="pre">tar</span></code> files) but have the extension <code class="docutils literal"><span class="pre">.spkg</span></code>
to discourage confusion. Although Sage packages are packed using tar
and/or bzip2, note that <code class="docutils literal"><span class="pre">.spkg</span></code> files contain control information
(installation scripts and metadata) that are necessary for building
and installing them.  When you compile Sage from a source distribution
(or when you run <code class="docutils literal"><span class="pre">sage</span> <span class="pre">-p</span> <span class="pre">&lt;pkg&gt;</span></code>), the file
<code class="docutils literal"><span class="pre">SAGE_ROOT/build/bin/sage-spkg</span></code> takes care of the unpacking,
compilation, and installation of Sage packages for you. You can type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="o">-</span><span class="n">jxvf</span> <span class="n">mypackage</span><span class="o">-</span><span class="n">version</span><span class="o">.</span><span class="n">spkg</span>
</pre></div>
</div>
<p>to extract an spkg and see what is inside.  If you want to create a
new Sage package, it is recommended that you start by examining some
existing spkg&#8217;s. The URL
<a class="reference external" href="http://www.sagemath.org/download-packages.html">http://www.sagemath.org/download-packages.html</a> lists spkg&#8217;s available
for download.</p>
<div class="section" id="naming-your-spkg">
<h3>Naming Your SPKG<a class="headerlink" href="#naming-your-spkg" title="Permalink to this headline">¶</a></h3>
<p>Each Sage spkg has a name of the following form:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">BASENAME</span><span class="o">-</span><span class="n">VERSION</span><span class="o">.</span><span class="n">spkg</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">BASENAME</span></code> is the name of the package; it may contain lower-case
letters, numbers, and underscores, but no hyphens.  <code class="docutils literal"><span class="pre">VERSION</span></code> is the
version number; it should start with a number and may contain numbers,
letters, dots, and hyphens; it may end in a string of the form &#8220;pNUM&#8221;,
where &#8220;NUM&#8221; is a non-negative integer.  If your spkg is a &#8220;vanilla&#8221;
(unmodified) version of some piece of software, say version 5.3 of
&#8220;my-python-package&#8221;, then <code class="docutils literal"><span class="pre">BASENAME</span></code> would be &#8220;my_python_package&#8221; &#8211;
note the change from hyphens to underscores, because <code class="docutils literal"><span class="pre">BASENAME</span></code>
should not contain any hyphens &#8211; and <code class="docutils literal"><span class="pre">VERSION</span></code> would be &#8220;5.3&#8221;.  If
you need to modify the software to use it with Sage (as described
below and in the chapter <a class="reference internal" href="#section-old-spkg-patching-overview"><span class="std std-ref">Overview of Patching SPKGs</span></a>),
then <code class="docutils literal"><span class="pre">VERSION</span></code> would be &#8220;5.3.p0&#8221;, the &#8220;p0&#8221; indicating a patch-level
of 0.  If someone adds more patches, later, this would become &#8220;p1&#8221;,
then &#8220;p2&#8221;, etc.</p>
<p>The string <code class="docutils literal"><span class="pre">VERSION</span></code> must be present.  If you are using a piece
software with no obvious version number, use a date. To give your spkg
a name like this, create a directory called <code class="docutils literal"><span class="pre">BASENAME-VERSION</span></code> and
put your files in that directory &#8211; the next section describes the
directory structure.</p>
</div>
<div class="section" id="directory-structure">
<h3>Directory Structure<a class="headerlink" href="#directory-structure" title="Permalink to this headline">¶</a></h3>
<p>Put your files in a directory with a name like <code class="docutils literal"><span class="pre">mypackage-0.1</span></code>, as
described above.  If you are porting
another software package, then the directory should contain a
subdirectory <code class="docutils literal"><span class="pre">src/</span></code>, containing an unaltered copy of the package.
Every file not in <code class="docutils literal"><span class="pre">src/</span></code> should be under version control, i.e. checked
into an hg repository.</p>
<p>More precisely, the directory should contain the following:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">src/</span></code>: this directory contains vanilla upstream code, with a few
exceptions, e.g. when the spkg shipped with Sage is in effect
upstream, and development on that code base is happening in close
coordination with Sage.  See John Cremona&#8217;s  eclib spkg, for
instance. The directory <code class="docutils literal"><span class="pre">src/</span></code> must not be under revision control.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">.hg</span></code>, <code class="docutils literal"><span class="pre">.hgignore</span></code>, and <code class="docutils literal"><span class="pre">.hgtags</span></code>: Old-style spkgs use
Mercurial for its revision control system. The hidden directory
<code class="docutils literal"><span class="pre">.hg</span></code> is part of the standard Sage spkg layout.  It contains the
Mercurial repository for all files not in the <code class="docutils literal"><span class="pre">src/</span></code> directory.
To create this Mercurial repository from scratch, you should do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">hg</span> <span class="n">init</span>
</pre></div>
</div>
<p>The files <code class="docutils literal"><span class="pre">.hgignore</span></code> and <code class="docutils literal"><span class="pre">.hgtags</span></code> also belong to the Mercurial
repository.  The file <code class="docutils literal"><span class="pre">.hgtags</span></code> is optional, and is frequently
omitted.  You should make sure that the file <code class="docutils literal"><span class="pre">.hgignore</span></code> contains
&#8220;src/&#8221;, since we are not tracking its content.  Indeed, frequently
this file contains only a single line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">src</span><span class="o">/</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">spkg-install</span></code>: this file contains the install script.  See
<a class="reference internal" href="#section-old-spkg-install"><span class="std std-ref">The File spkg-install</span></a> for more information and a template.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">SPKG.txt</span></code>: this file describes the spkg in wiki format.  Each new
revision needs an updated changelog entry or the spkg will get an
automatic &#8220;needs work&#8221; at review time.  See
<a class="reference internal" href="#section-old-spkg-spkg-txt"><span class="std std-ref">The File SPKG.txt</span></a> for a template.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">spkg-check</span></code>: this file runs the test suite.  This is somewhat
optional since not all spkg&#8217;s have test suites. If possible, do
create such a script since it helps isolate bugs in upstream
packages.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">patches/</span></code>: this directory contains patches to source files in
<code class="docutils literal"><span class="pre">src/</span></code>.  See <a class="reference internal" href="#section-old-spkg-patching-overview"><span class="std std-ref">Overview of Patching SPKGs</span></a>.  Patches
to files in <code class="docutils literal"><span class="pre">src/</span></code> should be applied in <code class="docutils literal"><span class="pre">spkg-install</span></code>, and all
patches must be self-documenting, i.e. the header must contain what
they do, if they are platform specific, if they should be pushed
upstream, etc. To ensure that all patched versions of upstream
source files under <code class="docutils literal"><span class="pre">src/</span></code> are under revision control, the whole
directory <code class="docutils literal"><span class="pre">patches/</span></code> must be under revision control.</p>
</li>
</ul>
<p><strong>Never</strong> apply patches to upstream source files under <code class="docutils literal"><span class="pre">src/</span></code> and
then package up an spkg. Such a mixture of upstream source with Sage
specific patched versions is a recipe for confusion. There must be a
<strong>clean separation</strong> between the source provided by the upstream
project and the patched versions that the Sage project generates based
on top of the upstream source.</p>
<p>The only exception to this rule is for <em>removals</em> of unused
files or directories.  Some packages contain parts which are not needed
for Sage.  To save space, these may be removed directly from <code class="docutils literal"><span class="pre">src/</span></code>.
But be sure to document this in the &#8220;Special Update/Build Instructions&#8221;
section in <code class="docutils literal"><span class="pre">SPKG.txt</span></code>!</p>
</div>
<div class="section" id="the-file-spkg-install">
<span id="section-old-spkg-install"></span><h3>The File spkg-install<a class="headerlink" href="#the-file-spkg-install" title="Permalink to this headline">¶</a></h3>
<p>The script <code class="docutils literal"><span class="pre">spkg-install</span></code> is run during installation of the Sage
package. In this script, you may make the following assumptions:</p>
<ul>
<li><p class="first">The PATH has the locations of <code class="docutils literal"><span class="pre">sage</span></code> and <code class="docutils literal"><span class="pre">python</span></code> (from the Sage
installation) at the front. Thus the command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
<p>will run the correct version of Python with everything set up
correctly. Also, running <code class="docutils literal"><span class="pre">gap</span></code> or <code class="docutils literal"><span class="pre">Singular</span></code>, for example, will
run the correct version.</p>
</li>
<li><p class="first">The environment variable <code class="docutils literal"><span class="pre">SAGE_ROOT</span></code> points to the root directory
of the Sage installation.</p>
</li>
<li><p class="first">The environment variable <code class="docutils literal"><span class="pre">SAGE_LOCAL</span></code> points to the
<code class="docutils literal"><span class="pre">SAGE_ROOT/local</span></code> directory of the Sage installation.</p>
</li>
</ul>
<p>The <code class="docutils literal"><span class="pre">spkg-install</span></code> script should copy your files to the appropriate
place after doing any build that is necessary.  Here is a template:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>#!/usr/bin/env bash

if [ -z &quot;$SAGE_LOCAL&quot; ]; then
    echo &gt;&amp;2 &quot;SAGE_LOCAL undefined ... exiting&quot;
    echo &gt;&amp;2 &quot;Maybe run &#39;sage --sh&#39;?&quot;
    exit 1
fi

cd src

# Apply patches.  See SPKG.txt for information about what each patch
# does.
for patch in ../patches/*.patch; do
    [ -r &quot;$patch&quot; ] || continue  # Skip non-existing or non-readable patches
    patch -p1 &lt;&quot;$patch&quot;
    if [ $? -ne 0 ]; then
        echo &gt;&amp;2 &quot;Error applying &#39;$patch&#39;&quot;
        exit 1
    fi
done

./configure --prefix=&quot;$SAGE_LOCAL&quot;
if [ $? -ne 0 ]; then
    echo &gt;&amp;2 &quot;Error configuring PACKAGE_NAME.&quot;
    exit 1
fi

$MAKE
if [ $? -ne 0 ]; then
    echo &gt;&amp;2 &quot;Error building PACKAGE_NAME.&quot;
    exit 1
fi

$MAKE install
if [ $? -ne 0 ]; then
    echo &gt;&amp;2 &quot;Error installing PACKAGE_NAME.&quot;
    exit 1
fi

if [ &quot;$SAGE_SPKG_INSTALL_DOCS&quot; = yes ] ; then
    # Before trying to build the documentation, check if any
    # needed programs are present. In the example below, we
    # check for &#39;latex&#39;, but this will depend on the package.
    # Some packages may need no extra tools installed, others
    # may require some.  We use &#39;command -v&#39; for testing this,
    # and not &#39;which&#39; since &#39;which&#39; is not portable, whereas
    # &#39;command -v&#39; is defined by POSIX.

    # if [ `command -v latex` ] ; then
    #    echo &quot;Good, latex was found, so building the documentation&quot;
    # else
    #    echo &quot;Sorry, can&#39;t build the documentation for PACKAGE_NAME as latex is not installed&quot;
    #    exit 1
    # fi


    # make the documentation in a package-specific way
    # for example, we might have
    # cd doc
    # $MAKE html

    if [ $? -ne 0 ]; then
        echo &gt;&amp;2 &quot;Error building PACKAGE_NAME docs.&quot;
        exit 1
    fi
    mkdir -p &quot;$SAGE_ROOT/local/share/doc/PACKAGE_NAME&quot;
    # assuming the docs are in doc/*
    cp -R doc/* &quot;$SAGE_ROOT/local/share/doc/PACKAGE_NAME&quot;
fi
</pre></div>
</div>
<p>Note that the first line is <code class="docutils literal"><span class="pre">#!/usr/bin/env</span> <span class="pre">bash</span></code>; this is important
for portability.  Next, the script checks that <code class="docutils literal"><span class="pre">SAGE_LOCAL</span></code> is
defined to make sure that the Sage environment has been set.  After
this, the script may simply run <code class="docutils literal"><span class="pre">cd</span> <span class="pre">src</span></code> and then call either
<code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code> or the autotools sequence
<code class="docutils literal"><span class="pre">./configure</span> <span class="pre">&amp;&amp;</span> <span class="pre">make</span> <span class="pre">&amp;&amp;</span> <span class="pre">make</span> <span class="pre">install</span></code>, or something else along these
lines.</p>
<p>Sometimes, though, it can be more complicated. For example, you might need
to apply the patches from the <code class="docutils literal"><span class="pre">patches</span></code> directory in a particular order. Also,
you should first build (e.g. with <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">build</span></code>, exiting
if there is an error), before installing (e.g. with <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span>
<span class="pre">install</span></code>). In this way, you would not overwrite a working older
version with a non-working newer version of the spkg.</p>
<p>When copying documentation to
<code class="docutils literal"><span class="pre">$SAGE_ROOT/local/share/doc/PACKAGE_NAME</span></code>, it may be necessary to
check that only the actual documentation files intended for the user
are copied.  For example, if the documentation is built from <code class="docutils literal"><span class="pre">.tex</span></code>
files, you may just need to copy the resulting pdf files, rather than
copying the entire doc directory.  When generating documentation using
Sphinx, copying the <code class="docutils literal"><span class="pre">build/html</span></code> directory generally will copy just
the actual output intended for the user.</p>
</div>
<div class="section" id="the-file-spkg-txt">
<span id="section-old-spkg-spkg-txt"></span><h3>The File SPKG.txt<a class="headerlink" href="#the-file-spkg-txt" title="Permalink to this headline">¶</a></h3>
<p>The old-style <code class="docutils literal"><span class="pre">SPKG.txt</span></code> file is the same as described in
<a class="reference internal" href="packaging.html#section-spkg-spkg-txt"><span class="std std-ref">The SPKG.txt File</span></a>, but with a hand-maintained changelog
appended since the contents are not part of the Sage repository
tree. It should follow the following pattern:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="n">Changelog</span> <span class="o">==</span>

<span class="n">Provide</span> <span class="n">a</span> <span class="n">changelog</span> <span class="n">of</span> <span class="n">the</span> <span class="n">spkg</span> <span class="n">here</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">entries</span> <span class="n">have</span> <span class="n">this</span> <span class="nb">format</span><span class="p">:</span>

<span class="o">===</span> <span class="n">mypackage</span><span class="o">-</span><span class="mf">0.1</span><span class="o">.</span><span class="n">p0</span> <span class="p">(</span><span class="n">Mary</span> <span class="n">Smith</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Jan</span> <span class="mi">2012</span><span class="p">)</span> <span class="o">===</span>

 <span class="o">*</span> <span class="n">Patch</span> <span class="n">src</span><span class="o">/</span><span class="n">configure</span> <span class="n">so</span> <span class="n">it</span> <span class="n">builds</span> <span class="n">on</span> <span class="n">Solaris</span><span class="o">.</span> <span class="n">See</span> <span class="n">Sage</span> <span class="n">trac</span> <span class="c1">#137.</span>

<span class="o">===</span> <span class="n">mypackage</span><span class="o">-</span><span class="mf">0.1</span> <span class="p">(</span><span class="n">Leonhard</span> <span class="n">Euler</span><span class="p">,</span> <span class="mi">17</span> <span class="n">September</span> <span class="mi">1783</span><span class="p">)</span> <span class="o">===</span>

 <span class="o">*</span> <span class="n">Initial</span> <span class="n">release</span><span class="o">.</span>  <span class="n">See</span> <span class="n">Sage</span> <span class="n">trac</span> <span class="c1">#007.</span>
</pre></div>
</div>
<p>When the directory (say, <code class="docutils literal"><span class="pre">mypackage-0.1</span></code>) is ready, the command</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sage</span> <span class="o">--</span><span class="n">pkg</span> <span class="n">mypackage</span><span class="o">-</span><span class="mf">0.1</span>
</pre></div>
</div>
<p>will create the file <code class="docutils literal"><span class="pre">mypackage-0.1.spkg</span></code>.  As noted above, this
creates a compressed tar file. Running <code class="docutils literal"><span class="pre">sage</span> <span class="pre">--pkg_nc</span> <span class="pre">mypackage-0.1</span></code>
creates an uncompressed tar file.</p>
<p>When your spkg is ready, you should post about it on <code class="docutils literal"><span class="pre">sage-devel</span></code>.
If people there think it is a good idea, then post a link to the spkg
on the Sage trac server (see <a class="reference internal" href="trac.html#chapter-sage-trac"><span class="std std-ref">The Sage Trac Server</span></a>) so it can be
refereed.  Do not post the spkg itself to the trac server: you only
need to provide a link to your spkg.  If your spkg gets a positive
review, it might be included into the core Sage library, or it might
become an optional download from the Sage website, so anybody can
automatically install it by typing <code class="docutils literal"><span class="pre">sage</span> <span class="pre">-p</span> <span class="pre">mypackage-version.spkg</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>For any spkg:</p>
<ul class="last simple">
<li>Make sure that the hg repository contains every file outside the
<code class="docutils literal"><span class="pre">src</span></code> directory, and that these are all up-to-date and committed
into the repository.</li>
<li>Include an <code class="docutils literal"><span class="pre">spkg-check</span></code> file if possible (see <a class="reference external" href="http://trac.sagemath.org/sage_trac/ticket/299">trac ticket #299</a>).</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">External Magma code goes in <code class="docutils literal"><span class="pre">SAGE_ROOT/src/ext/magma/user</span></code>, so
if you want to redistribute Magma code with Sage as a package that
Magma-enabled users can use, that is where you would put it. You
would also want to have relevant Python code to make the Magma
code easily usable.</p>
</div>
</div>
</div>
<div class="section" id="avoiding-troubles">
<span id="section-old-spkg-avoiding-troubles"></span><h2>Avoiding Troubles<a class="headerlink" href="#avoiding-troubles" title="Permalink to this headline">¶</a></h2>
<p>This section contains some guidelines on what an spkg must never do to
a Sage installation. You are encouraged to produce an spkg that is as
self-contained as possible.</p>
<ol class="arabic simple">
<li>An spkg must not modify an existing source file in the Sage
library.</li>
<li>Do not allow an spkg to modify another spkg. One spkg can depend on
other spkg &#8211; see above. You need to first test for the existence of the
prerequisite spkg before installing an spkg that depends on it.</li>
</ol>
</div>
<div class="section" id="overview-of-patching-spkgs">
<span id="section-old-spkg-patching-overview"></span><h2>Overview of Patching SPKGs<a class="headerlink" href="#overview-of-patching-spkgs" title="Permalink to this headline">¶</a></h2>
<p>Make sure you are familiar with the structure and conventions relating
to spkg&#8217;s; see the chapter <a class="reference internal" href="#chapter-old-spkg"><span class="std std-ref">Packaging Old-Style SPKGs</span></a> for
details. Patching an spkg involves patching the installation script of
the spkg and/or patching the upstream source code contained in the
spkg. Say you want to patch the Matplotlib package
<code class="docutils literal"><span class="pre">matplotlib-1.0.1.p0</span></code>. Note that &#8220;p0&#8221; denotes the patch level of the
spkg, while &#8220;1.0.1&#8221; refers to the upstream version of Matplotlib as
contained under <code class="docutils literal"><span class="pre">matplotlib-1.0.1.p0/src/</span></code>. The installation script
of that spkg is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="mf">1.</span><span class="n">p0</span><span class="o">/</span><span class="n">spkg</span><span class="o">-</span><span class="n">install</span>
</pre></div>
</div>
<p>In general, a script with the name <code class="docutils literal"><span class="pre">spkg-install</span></code>  is an
installation script for an spkg. To patch the installation script, use
a text editor to edit that script. Then in the log file <code class="docutils literal"><span class="pre">SPKG.txt</span></code>,
provide a high-level description of your changes. Once you are
satisfied with your changes in the installation script and the log
file <code class="docutils literal"><span class="pre">SPKG.txt</span></code>, use Mercurial to check in your changes and make
sure to provide a meaningful commit message.</p>
<p>The directory <code class="docutils literal"><span class="pre">src/</span></code> contains the source code provided by the
upstream project. For example, the source code of Matplotlib 1.0.1 is
contained under</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="mf">1.</span><span class="n">p0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span>
</pre></div>
</div>
<p>To patch the upstream source code, you should edit a copy of the
relevant file &#8211; files in the <code class="docutils literal"><span class="pre">src/</span></code> directory should be untouched,
&#8220;vanilla&#8221; versions of the source code.  For example, you might copy
the entire <code class="docutils literal"><span class="pre">src/</span></code> directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ pwd
matplotlib-1.0.1.p0
$ cp -pR src src-patched
</pre></div>
</div>
<p>Then edit files in <code class="docutils literal"><span class="pre">src-patched/</span></code>.  Once you are satisfied with your
changes, generate a unified diff between the original file and the
edited one, and save it in <code class="docutils literal"><span class="pre">patches/</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ diff -u src/configure src-patched/configure &gt; patches/configure.patch
</pre></div>
</div>
<p>Save the unified diff to a file with the same name as the source file
you patched, but using the file extension &#8221;.patch&#8221;. Note that the
directory <code class="docutils literal"><span class="pre">src/</span></code> should not be under revision control, whereas
<code class="docutils literal"><span class="pre">patches/</span></code> must be under revision control. The Mercurial
configuration file <code class="docutils literal"><span class="pre">.hgignore</span></code> should contain the following line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">src</span><span class="o">/</span>
</pre></div>
</div>
<p>Ensure that the installation script <code class="docutils literal"><span class="pre">spkg-install</span></code> contains code to
apply the patches to the relevant files under <code class="docutils literal"><span class="pre">src/</span></code>. For example,
the file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="mf">1.</span><span class="n">p0</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="n">finance</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">patch</span>
</pre></div>
</div>
<p>is a patch for the file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="mf">1.</span><span class="n">p0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">matplotlib</span><span class="o">/</span><span class="n">finance</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>The installation script <code class="docutils literal"><span class="pre">matplotlib-1.0.1.p0/spkg-install</span></code> contains the
following code to install the relevant patches:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd src

# Apply patches.  See SPKG.txt for information about what each patch
# does.
for patch in ../patches/*.patch; do
    patch -p1 &lt;&quot;$patch&quot;
    if [ $? -ne 0 ]; then
        echo &gt;&amp;2 &quot;Error applying &#39;$patch&#39;&quot;
        exit 1
    fi
done
</pre></div>
</div>
<p>Of course, this could be modified if the order in which the patches
are applied is important, or if some patches were platform-dependent.
For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>if [ &quot;$UNAME&quot; = &quot;Darwin&quot; ]; then
    for patch in ../patches/darwin/*.patch; do
        patch -p1 &lt;&quot;$patch&quot;
        if [ $? -ne 0 ]; then
            echo &gt;&amp;2 &quot;Error applying &#39;$patch&#39;&quot;
            exit 1
        fi
    done
fi
</pre></div>
</div>
<p>(The environment variable <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">UNAME</span></code> is defined by the script
<code class="docutils literal"><span class="pre">sage-env</span></code>, and is available when <code class="docutils literal"><span class="pre">spkg-install</span></code> is run.)</p>
<p>Now provide a high-level explanation of your changes in <code class="docutils literal"><span class="pre">SPKG.txt</span></code>.
Note the format of <code class="docutils literal"><span class="pre">SPKG.txt</span></code> &#8211; see the chapter
<a class="reference internal" href="#chapter-old-spkg"><span class="std std-ref">Packaging Old-Style SPKGs</span></a> for details.  Once you are satisfied with your
changes, use Mercurial to check in your changes with a meaningful
commit message.  Then use the command <code class="docutils literal"><span class="pre">hg</span> <span class="pre">tag</span></code> to tag the tip with
the new version number (using &#8220;p1&#8221; instead of &#8220;p0&#8221;: we have made
changes, so we need to update the patch level):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ hg tag matplotlib-1.0.1.p1
</pre></div>
</div>
<p>Next, rename the directory <code class="docutils literal"><span class="pre">matplotlib-1.0.1.p0</span></code> to
<code class="docutils literal"><span class="pre">matplotlib-1.0.1.p1</span></code> to match the new patch level.  To produce the
actual spkg file, change to the parent directory of
<code class="docutils literal"><span class="pre">matplotlib-1.0.1.p1</span></code> and execute</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ /path/to/sage-x.y.z/sage --pkg matplotlib-1.0.1.p1
Creating Sage package matplotlib-1.0.1.p1

Created package matplotlib-1.0.1.p1.spkg.

    NAME: matplotlib
 VERSION: 1.0.1.p1
    SIZE: 11.8M
 HG REPO: Good
SPKG.txt: Good
</pre></div>
</div>
<p>Spkg files are either bzipped tar files or just plain tar files; the
command <code class="docutils literal"><span class="pre">sage</span> <span class="pre">--pkg</span> <span class="pre">...</span></code> produces the bzipped version.  If your spkg
contains mostly binary files which will not compress well, you can use
<code class="docutils literal"><span class="pre">sage</span> <span class="pre">--pkg_nc</span> <span class="pre">...</span></code> to produce an uncompressed version, i.e., a
plain tar file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sage --pkg_nc matplotlib-1.0.1.p0/
Creating Sage package matplotlib-1.0.1.p0/ with no compression

Created package matplotlib-1.0.1.p0.spkg.

    NAME: matplotlib
 VERSION: 1.0.1.p0
    SIZE: 32.8M
 HG REPO: Good
SPKG.txt: Good
</pre></div>
</div>
<p>Note that this is almost three times the size of the compressed
version, so we should use the compressed version!</p>
<p>At this point, you might want to submit your patched spkg for review.
So provide a URL to your spkg on the relevant trac ticket and/or in an
email to the relevant mailing list. Usually, you should not upload
your spkg itself to the relevant trac ticket &#8211; don&#8217;t post large
binary files to the trac server.</p>
</div>
<div class="section" id="spkg-versioning">
<h2>SPKG Versioning<a class="headerlink" href="#spkg-versioning" title="Permalink to this headline">¶</a></h2>
<p>If you want to bump up the version of an spkg, you need to follow some
naming conventions. Use the name and version number as given by the
upstream project, e.g. <code class="docutils literal"><span class="pre">matplotlib-1.0.1</span></code>. If the upstream package is
taken from some revision other than a stable version, you need to
append the date at which the revision is made, e.g. the Singular
package <code class="docutils literal"><span class="pre">singular-3-1-0-4-20090818.p3.spkg</span></code> is made with the
revision as of 2009-08-18. If you start afresh from an upstream
release without any patches to its source code, the resulting spkg
need not have any patch-level labels (appending &#8221;.p0&#8221; is allowed, but
is optional). For example, <code class="docutils literal"><span class="pre">sagenb-0.6.spkg</span></code>
is taken from the upstream stable version <code class="docutils literal"><span class="pre">sagenb-0.6</span></code> without any
patches applied to its source code. So you do not see any patch-level
numbering such as <code class="docutils literal"><span class="pre">.p0</span></code> or <code class="docutils literal"><span class="pre">.p1</span></code>.</p>
<p>Say you start with <code class="docutils literal"><span class="pre">matplotlib-1.0.1.p0</span></code> and you want to replace
Matplotlib 1.0.1 with version 1.0.2. This entails replacing the source
code for Matplotlib 1.0.1 under <code class="docutils literal"><span class="pre">matplotlib-1.0.1.p0/src/</span></code> with the
new source code. To start with, follow the naming conventions as
described in the section <a class="reference internal" href="#section-old-spkg-patching-overview"><span class="std std-ref">Overview of Patching SPKGs</span></a>. If
necessary, remove any obsolete patches and create any new ones,
placing them in the <code class="docutils literal"><span class="pre">patches/</span></code> directory.  Modify the script
<code class="docutils literal"><span class="pre">spkg-install</span></code> to take any changes to the patches into account; you
might also have to deal with changes to how the new version of the
source code builds. Then package your replacement spkg using the Sage
command line options <code class="docutils literal"><span class="pre">--pkg</span></code> or <code class="docutils literal"><span class="pre">--pkg_nc</span></code> (or tar and bzip2).</p>
<p>To install your replacement spkg, you use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sage</span> <span class="o">-</span><span class="n">p</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">URL</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">package</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">spkg</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sage</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">package</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">spkg</span>
</pre></div>
</div>
<p>To compile Sage from source with the replacement (standard) spkg,
untar a Sage source tarball, remove the existing spkg under
<code class="docutils literal"><span class="pre">SAGE_ROOT/spkg/standard/</span></code>. In its place, put your replacement
spkg. Then execute <code class="docutils literal"><span class="pre">make</span></code> from <code class="docutils literal"><span class="pre">SAGE_ROOT</span></code>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Packaging Old-Style SPKGs</a><ul>
<li><a class="reference internal" href="#creating-an-old-style-spkg">Creating an Old-Style SPKG</a><ul>
<li><a class="reference internal" href="#naming-your-spkg">Naming Your SPKG</a></li>
<li><a class="reference internal" href="#directory-structure">Directory Structure</a></li>
<li><a class="reference internal" href="#the-file-spkg-install">The File spkg-install</a></li>
<li><a class="reference internal" href="#the-file-spkg-txt">The File SPKG.txt</a></li>
</ul>
</li>
<li><a class="reference internal" href="#avoiding-troubles">Avoiding Troubles</a></li>
<li><a class="reference internal" href="#overview-of-patching-spkgs">Overview of Patching SPKGs</a></li>
<li><a class="reference internal" href="#spkg-versioning">SPKG Versioning</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="packaging.html"
                                  title="previous chapter">Packaging Third-Party Code</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="sagenb/index.html"
                                  title="next chapter">Sage Notebook Developer Guide</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/packaging_old_spkgs.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <!-- The shading of the "Go" button should be consistent -->
                <!-- with the colour of the header and footer. See the file -->
                <!-- doc/common/themes/sage/theme.conf for colours used by -->
                <!-- the Sage theme. -->
                <input type="submit" style="background-color: #B8B9F6" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="sagenb/index.html" title="Sage Notebook Developer Guide"
             >next</a> |</li>
        <li class="right" >
          <a href="packaging.html" title="Packaging Third-Party Code"
             >previous</a> |</li>
  
    
      <a href="../index.html"><img src="_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li class="nav-item nav-item-0"><a href="index.html">Developer&#39;s Guide v7.5</a> &raquo;</li>
 
      </ul>
    </div>
    
    <div class="footer" role="contentinfo">
        &copy; Copyright 2005--2017, The Sage Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.4.
    </div>
    <script type="text/javascript">
/*global jQuery, window */
/* Sphinx sidebar toggle.  Putting this code at the end of the body
 * enables the toggle for the live, static, and offline docs.  Note:
 * sage.misc.html.math_parse() eats jQuery's dollar-sign shortcut. */
var jq = jQuery;
jq(document).ready(function () {
    var bar, bod, bg, fg, key, tog, wid_old, wid_new, resize, get_state, set_state;
    bod = jq('div.bodywrapper');
    bar = jq('div.sphinxsidebar');
    tog = jq('<div class="sphinxsidebartoggle"></div>');

    /* Delayed resize helper.  Not perfect but good enough. */
    resize = function () {
        setTimeout(function () {
            tog.height(bod.height());
        }, 100);
    };
    jq(window).resize(function () {
        resize();
    });

    /* Setup and add the toggle. See Sphinx v0.5.1 default.css. */
    fg = jq('div.sphinxsidebar p a').css('color') || 'rgb(152, 219, 204)';
    bg = jq('div.document').css('background-color') || 'rgb(28, 78, 99)';
    wid_old = '230px';
    wid_new = '5px';
    tog.css('background-color', bg)
        .css('border-width', '0px')
        .css('border-right', wid_new + ' ridge ' + bg)
        .css('cursor', 'pointer')
        .css('position', 'absolute')
        .css('left', '-' + wid_new)
        .css('top', '0px')
        .css('width', wid_new);
    bod.css('position', 'relative');
    bod.prepend(tog);
    resize();

    /* Cookie helpers. */
    key = 'sphinxsidebar=';
    set_state = function (s) {
        var date = new Date();
        /* Expiry in 7 days. */
        date.setTime(date.getTime() + (7 * 24 * 3600 * 1000));
        document.cookie = key + encodeURIComponent(s) + '; expires=' +
            date.toUTCString() + '; path=/';
    };
    get_state = function () {
        var i, c, crumbs = document.cookie.split(';');
        for (i = 0; i < crumbs.length; i += 1) {
            c = crumbs[i].replace(/^\s+/, '');
            if (c.indexOf(key) === 0) {
                return decodeURIComponent(c.substring(key.length, c.length));
            }
        }
        return null;
    };

    /* Event handlers. */
    tog.mouseover(function (ev) {
        tog.css('border-right-color', fg);
    }).mouseout(function (ev) {
        tog.css('border-right-color', bg);
    }).click(function (ev) {
        if (bod.hasClass('wide')) {
            bod.removeClass('wide');
            bod.css('margin-left', wid_old);
            bar.css('width', wid_old);
            bar.show();
            set_state('visible');
        } else {
            set_state('hidden');
            bar.hide();
            bar.css('width', '0px');
            bod.css('margin-left', wid_new);
            bod.addClass('wide');
        }
        resize();
    });

    /* Hide the normally visible sidebar? */
    if (get_state() === 'hidden') {
        tog.trigger('click');
    } else {
        set_state('visible');
    }
});
    </script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66100-14', 'auto');
  ga('send', 'pageview');
</script>
  </body>
</html>
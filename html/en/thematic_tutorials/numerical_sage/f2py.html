
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=600, initial-scale=1">
    <title>f2py &#8212; Thematic Tutorials v9.4</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sage.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="More Interesting Examples with f2py" href="f2py_examples.html" />
    <link rel="prev" title="Using Compiled Code Interactively" href="using_compiled_code_iteractively.html" />
    <link rel="icon" href="../_static/sageicon.png" type="image/x-icon" />
    <script src="../_static/thebe.js" type="text/javascript"></script>
    <script src="../_static/thebe-sage.js" type="text/javascript"></script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="f2py_examples.html" title="More Interesting Examples with f2py"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="using_compiled_code_iteractively.html" title="Using Compiled Code Interactively"
             accesskey="P">previous</a> |</li>
  
    
      <a href="../../index.html"><img src="../_static/logo_sagemath_black.svg" height="28" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li class="nav-item nav-item-0"><a href="../index.html">Thematic Tutorials v9.4</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../toctree.html" >Thematic tutorial document tree</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Numerical Computing with Sage</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="using_compiled_code_iteractively.html" accesskey="U">Using Compiled Code Interactively</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">f2py</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="f2py">
<h1>f2py<a class="headerlink" href="#f2py" title="Permalink to this headline">¶</a></h1>
<p>F2py is a very nice package that automatically wraps fortran code
and makes it callable from Python. The Fibonacci examples are taken
from the f2py webpage <a class="reference external" href="http://cens.ioc.ee/projects/f2py2e/">http://cens.ioc.ee/projects/f2py2e/</a>.</p>
<p>From the notebook the magic %fortran will automatically compile any
fortran code in a cell and all the subroutines will become callable
functions (though the names will be converted to lowercase.) As an
example paste the following into a cell. It is important that the
spacing is correct as by default the code is treated as fixed
format fortran and the compiler will complain if things are not in
the correct column. To avoid this, you can write fortran 90 code
instead by making your first line !f90. There will be an example of
this later.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="p">%</span><span class="n">fortran</span>
<span class="n">C</span> <span class="k">FILE</span><span class="p">:</span> <span class="n">FIB1</span><span class="p">.</span><span class="n">F</span>
      <span class="k">SUBROUTINE </span><span class="n">FIB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="n">C</span>
<span class="n">C</span>     <span class="n">CALCULATE</span> <span class="n">FIRST</span> <span class="n">N</span> <span class="n">FIBONACCI</span> <span class="n">NUMBERS</span>
<span class="n">C</span>
      <span class="kt">INTEGER </span><span class="n">N</span>
      <span class="kt">REAL</span><span class="o">*</span><span class="mi">8</span> <span class="n">A</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
      <span class="k">DO </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0D0</span>
         <span class="n">ELSEIF</span> <span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.0D0</span>
         <span class="k">ELSE</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
         <span class="n">ENDIF</span>
      <span class="n">ENDDO</span>
      <span class="k">END</span>
<span class="n">C</span> <span class="k">END FILE </span><span class="n">FIB1</span><span class="p">.</span><span class="n">F</span>
</pre></div>
</div>
<p>Now evaluate it. It will be automatically compiled and imported
into Sage (though the name of imported function will be lowercase).
Now we want to try to call it, we need to somehow pass it an array
<span class="math notranslate nohighlight">\(A\)</span>, and the length of the array <span class="math notranslate nohighlight">\(N\)</span>. The way it
works is that numpy arrays will be automatically converted to
fortran arrays, and Python scalars converted to fortran scalars. So
to call fib we do the following.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="n">m</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">fib</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that fortran is a function that can be called on any string.
So if you have a fortran program in a file my
prog.f. Then you could do the following</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;my_prog.f&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">fortran</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>Now all the functions in my
prog.f are callable.</p>
<p>It is possible to call external libraries in your fortran code. You
simply need to tell f2py to link them in. For example suppose we
wish to write a program to solve a linear equation using lapack (a
linear algebra library). The function we want to use is called
dgesv and it has the following signature.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">SUBROUTINE </span><span class="n">DGESV</span><span class="p">(</span> <span class="n">N</span><span class="p">,</span> <span class="n">NRHS</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">LDA</span><span class="p">,</span> <span class="n">IPIV</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">LDB</span><span class="p">,</span> <span class="n">INFO</span> <span class="p">)</span>


<span class="o">*</span>  <span class="n">N</span>       <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="kt">INTEGER</span>
<span class="o">*</span>          <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">linear</span> <span class="n">equations</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.,</span> <span class="n">the</span> <span class="n">order</span> <span class="n">of</span> <span class="n">the</span>
<span class="o">*</span>          <span class="n">matrix</span> <span class="n">A</span><span class="p">.</span>  <span class="n">N</span> <span class="o">&gt;=</span> <span class="mf">0.</span>
<span class="o">*</span>
<span class="o">*</span>  <span class="n">NRHS</span>    <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="kt">INTEGER</span>
<span class="o">*</span>          <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">right</span> <span class="n">hand</span> <span class="n">sides</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.,</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">columns</span>
<span class="o">*</span>          <span class="n">of</span> <span class="n">the</span> <span class="n">matrix</span> <span class="n">B</span><span class="p">.</span>  <span class="n">NRHS</span> <span class="o">&gt;=</span> <span class="mf">0.</span>
<span class="o">*</span>
<span class="o">*</span>  <span class="n">A</span>       <span class="p">(</span><span class="n">input</span><span class="o">/</span><span class="n">output</span><span class="p">)</span> <span class="kt">DOUBLE PRECISION </span><span class="k">array</span><span class="p">,</span> <span class="k">dimension</span> <span class="p">(</span><span class="n">LDA</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="o">*</span>          <span class="n">On</span> <span class="k">entry</span><span class="p">,</span> <span class="n">the</span> <span class="n">N</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">N</span> <span class="n">coefficient</span> <span class="n">matrix</span> <span class="n">A</span><span class="p">.</span>
<span class="o">*</span>          <span class="n">On</span> <span class="k">exit</span><span class="p">,</span> <span class="n">the</span> <span class="n">factors</span> <span class="n">L</span> <span class="nb">and </span><span class="n">U</span> <span class="n">from</span> <span class="n">the</span> <span class="n">factorization</span>
<span class="o">*</span>          <span class="n">A</span> <span class="o">=</span> <span class="n">P</span><span class="o">*</span><span class="n">L</span><span class="o">*</span><span class="n">U</span><span class="p">;</span> <span class="n">the</span> <span class="n">unit</span> <span class="n">diagonal</span> <span class="n">elements</span> <span class="n">of</span> <span class="n">L</span> <span class="n">are</span> <span class="nb">not </span><span class="n">stored</span><span class="p">.</span>
<span class="o">*</span>
<span class="o">*</span>  <span class="n">LDA</span>     <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="kt">INTEGER</span>
<span class="o">*</span>          <span class="n">The</span> <span class="n">leading</span> <span class="k">dimension </span><span class="n">of</span> <span class="n">the</span> <span class="k">array </span><span class="n">A</span><span class="p">.</span>  <span class="n">LDA</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">).</span>
<span class="o">*</span>
<span class="o">*</span>  <span class="n">IPIV</span>    <span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="kt">INTEGER </span><span class="k">array</span><span class="p">,</span> <span class="k">dimension</span> <span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="o">*</span>          <span class="n">The</span> <span class="n">pivot</span> <span class="n">indices</span> <span class="n">that</span> <span class="n">define</span> <span class="n">the</span> <span class="n">permutation</span> <span class="n">matrix</span> <span class="n">P</span><span class="p">;</span>
<span class="o">*</span>          <span class="n">row</span> <span class="n">i</span> <span class="n">of</span> <span class="n">the</span> <span class="n">matrix</span> <span class="n">was</span> <span class="n">interchanged</span> <span class="n">with</span> <span class="n">row</span> <span class="n">IPIV</span><span class="p">(</span><span class="n">i</span><span class="p">).</span>
<span class="o">*</span>
<span class="o">*</span>  <span class="n">B</span>       <span class="p">(</span><span class="n">input</span><span class="o">/</span><span class="n">output</span><span class="p">)</span> <span class="kt">DOUBLE PRECISION </span><span class="k">array</span><span class="p">,</span> <span class="k">dimension</span> <span class="p">(</span><span class="n">LDB</span><span class="p">,</span><span class="n">NRHS</span><span class="p">)</span>
<span class="o">*</span>          <span class="n">On</span> <span class="k">entry</span><span class="p">,</span> <span class="n">the</span> <span class="n">N</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">NRHS</span> <span class="n">matrix</span> <span class="n">of</span> <span class="n">right</span> <span class="n">hand</span> <span class="n">side</span> <span class="n">matrix</span> <span class="n">B</span><span class="p">.</span>
<span class="o">*</span>          <span class="n">On</span> <span class="k">exit</span><span class="p">,</span> <span class="k">if </span><span class="n">INFO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">the</span> <span class="n">N</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">NRHS</span> <span class="n">solution</span> <span class="n">matrix</span> <span class="n">X</span><span class="p">.</span>
<span class="o">*</span>
<span class="o">*</span>  <span class="n">LDB</span>     <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="kt">INTEGER</span>
<span class="o">*</span>          <span class="n">The</span> <span class="n">leading</span> <span class="k">dimension </span><span class="n">of</span> <span class="n">the</span> <span class="k">array </span><span class="n">B</span><span class="p">.</span>  <span class="n">LDB</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">).</span>
<span class="o">*</span>
<span class="o">*</span>  <span class="n">INFO</span>    <span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="kt">INTEGER</span>
<span class="o">*</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">:</span>  <span class="n">successful</span> <span class="k">exit</span>
<span class="o">*</span>          <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="k">if </span><span class="n">INFO</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="n">the</span> <span class="n">i</span><span class="o">-</span><span class="n">th</span> <span class="n">argument</span> <span class="n">had</span> <span class="n">an</span> <span class="n">illegal</span> <span class="k">value</span>
<span class="o">*</span>          <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="k">if </span><span class="n">INFO</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">U</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">is </span><span class="n">exactly</span> <span class="n">zero</span><span class="p">.</span>  <span class="n">The</span> <span class="n">factorization</span>
<span class="o">*</span>                <span class="n">has</span> <span class="n">been</span> <span class="n">completed</span><span class="p">,</span> <span class="n">but</span> <span class="n">the</span> <span class="n">factor</span> <span class="n">U</span> <span class="k">is </span><span class="n">exactly</span>
<span class="o">*</span>                <span class="n">singular</span><span class="p">,</span> <span class="n">so</span> <span class="n">the</span> <span class="n">solution</span> <span class="n">could</span> <span class="nb">not </span><span class="n">be</span> <span class="n">computed</span><span class="p">.</span>
</pre></div>
</div>
<p>we could do the following. Note that the order that library are in
the list actually matters as it is the order in which they are
passed to gcc. Also fortran.libraries is simply a list of names of
libraries that are linked in. You can just directly set this list.
So that fortran.libraries=[‘lapack’,’blas’]is equivalent to the
following.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fortran</span><span class="o">.</span><span class="n">add_library</span><span class="p">(</span><span class="s1">&#39;lapack&#39;</span><span class="p">)</span>
<span class="n">fortran</span><span class="o">.</span><span class="n">add_library</span><span class="p">(</span><span class="s1">&#39;blas&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="p">%</span><span class="n">fortran</span>
<span class="c">!f90</span>
<span class="k">Subroutine </span><span class="n">LinearEquations</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="kt">Integer </span><span class="n">n</span>
<span class="kt">Real</span><span class="o">*</span><span class="mi">8</span> <span class="n">A</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="kt">Integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">pivot</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">ok</span>
<span class="k">call </span><span class="n">DGESV</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>There are a couple things to note about this. As we remarked
earlier, if the first line of the code is !f90, then it will be
treated as fortran 90 code and does not need to be in fixed format.
To use the above try</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">b</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">x</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">linearequations</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>This will solve the linear system ax=b and store the result in b.
If your library is not in Sage’s local/lib or in your path you can
add it to the search path using</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fortran</span><span class="o">.</span><span class="n">add_library_path</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>You can also directly set fortran.library
paths by assignment. It should be a list of paths (strings) to be
passed to gcc. To give you an idea of some more things you can do
with f2py, note that using intent statements you can control the
way the resulting Python function behaves a bit bitter. For example
consider the following modification of our original fibonacci
code.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">C</span> <span class="k">FILE</span><span class="p">:</span> <span class="n">FIB3</span><span class="p">.</span><span class="n">F</span>
      <span class="k">SUBROUTINE </span><span class="n">FIB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="n">C</span>
<span class="n">C</span>     <span class="n">CALCULATE</span> <span class="n">FIRST</span> <span class="n">N</span> <span class="n">FIBONACCI</span> <span class="n">NUMBERS</span>
<span class="n">C</span>
      <span class="kt">INTEGER </span><span class="n">N</span>
      <span class="kt">REAL</span><span class="o">*</span><span class="mi">8</span> <span class="n">A</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">Cf2py</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="n">n</span>
<span class="n">Cf2py</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="n">a</span>
<span class="n">Cf2py</span> <span class="n">depend</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="n">a</span>
      <span class="k">DO </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0D0</span>
         <span class="n">ELSEIF</span> <span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.0D0</span>
         <span class="k">ELSE</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
         <span class="n">ENDIF</span>
      <span class="n">ENDDO</span>
      <span class="k">END</span>
<span class="n">C</span> <span class="k">END FILE </span><span class="n">FIB3</span><span class="p">.</span><span class="n">F</span>
</pre></div>
</div>
<p>Note the comments with the intent statements. This tells f2py that
<span class="math notranslate nohighlight">\(n\)</span> is an input parameter and <span class="math notranslate nohighlight">\(a\)</span> is the output.
This is called as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="n">fib</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>In general you will pass everything declared intent(in) to the
fortran function and everything declared intent(out) will be
returned in a tuple. Note that declaring something intent(in) means
you only care about its value before the function is called not
afterwards. So in the above n tells us how many fiboncci numbers to
compute we need to specify this as an input, however we don’t need
to get n back as it doesn’t contain anything new. Similarly A is
intent(out) so we don’t need A to have an specific value
beforehand, we just care about the contents afterwards. F2py
generates a Python function so you only pass those declared
intent(in) and supplies empty workspaces for the remaining
arguments and it only returns those that are intent(out). All
arguments are intent(in) by default.</p>
<p>Consider now the following</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="p">%</span><span class="n">fortran</span>
        <span class="k">Subroutine </span><span class="n">Rescale</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="k">Implicit none</span>
<span class="k">        </span><span class="kt">Integer </span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span>
        <span class="kt">Real</span><span class="o">*</span><span class="mi">8</span> <span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">b</span>
        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">n</span>
           <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
             <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">b</span><span class="o">*</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
           <span class="k">end do</span>
<span class="k">        end do</span>
<span class="k">        end</span>
</pre></div>
</div>
<p>You might be expecting Rescale(a,n) to rescale a numpy matrix a.
Alas this doesn’t work. Anything you pass in is unchanged
afterwards. Note that in the fibonacci example above, the one
dimensional array was changed by the fortran code, similarly the
one dimensional vector b was replaced by its solution in the
example where we called lapack while the matrix A was not changed
even then dgesv says it modifies the input matrix. Why does this
not happen with the two dimensional array. Understanding this
requires that you are aware of the difference between how fortran
and C store arrays. Fortran stores a matrices using column ordering
while C stores them using row ordering. That is the matrix</p>
<div class="math notranslate nohighlight">
\[\begin{split}\left(
\begin{array}{ccc}
0 &amp; 1 &amp;2\\
3 &amp; 4 &amp; 5\\
\end{array}
\right)\end{split}\]</div>
<p>is stored as</p>
<blockquote>
<div><p><span class="math notranslate nohighlight">\((0\, 1\, 2\, 3\, 4\, 5\,) \,\,\,\, \text{ in C}\)</span></p>
<p><span class="math notranslate nohighlight">\((0\, 3\,1\, 4\, 2\, 5) \,\,\,\, \text{ in Fortran}\)</span></p>
</div></blockquote>
<p>One dimensional arrays are stored the same in C and Fortran.
Because of this f2py allows the fortran code to operate on one
dimensional vectors in place, so your fortran code will change one
dimensional numpy arrays passed to it. However, since two
dimensional arrays are different by default f2py copies the numpy
array (which is stored in C format) into a second array that is in
the fortran format (i.e. takes the transpose) and that is what is
passed to the fortran function. We will see a way to get around
this copying later. First let us point one way of writing the
rescale function.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="p">%</span><span class="n">fortran</span>

        <span class="k">Subroutine </span><span class="n">Rescale</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="k">Implicit none</span>
<span class="k">        </span><span class="kt">Integer </span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span>
        <span class="kt">Real</span><span class="o">*</span><span class="mi">8</span> <span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">b</span>
<span class="n">Cf2py</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">,</span><span class="n">out</span><span class="p">)</span> <span class="n">a</span>
        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">n</span>
           <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
             <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">b</span><span class="o">*</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
           <span class="k">end do</span>
<span class="k">        end do</span>
<span class="k">        end</span>
</pre></div>
</div>
<p>Note that to call this you would use</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">=</span><span class="n">rescale</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>Note here I am not passing in <span class="math notranslate nohighlight">\(n\)</span> which is the dimension of
<span class="math notranslate nohighlight">\(a\)</span>. Often f2py can figure this out. This is a good time to
mention that f2py automatically generates some documentation for
the Python version of the function so you can check what you need
to pass to it and what it will return. To use this try</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">rescale?</span>
</pre></div>
</div>
<p>The intent(in,out) directives tells f2py to take the contents of
<span class="math notranslate nohighlight">\(a\)</span> at the end of the subroutine and return them in a numpy
array. This still may not be what you want. The original
<span class="math notranslate nohighlight">\(a\)</span> that you pass in is unmodified. If you want to modify
the original <span class="math notranslate nohighlight">\(a\)</span> that you passed in use intent(inout). This
essentially lets your fortran code work with the data inplace.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="p">%</span><span class="n">fortran</span>

        <span class="k">Subroutine </span><span class="n">Rescale</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="k">Implicit none</span>
<span class="k">        </span><span class="kt">Integer </span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span>
        <span class="kt">Real</span><span class="o">*</span><span class="mi">8</span> <span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">b</span>
<span class="n">Cf2py</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="n">a</span>
        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">n</span>
           <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
             <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">b</span><span class="o">*</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
           <span class="k">end do</span>
<span class="k">        end do</span>
<span class="k">        end</span>
</pre></div>
</div>
<p>If you wish to have fortran code work with numpy arrays in place,
you should make sure that your numpy arrays are stored in fortran’s
format. You can ensure this by using the order=’FORTRAN’ keyword
when creating the arrays, as follows.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;FORTRAN&#39;</span><span class="p">)</span>
<span class="n">rescale</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
<p>After this executes, a will have the rescaled version of itself.
There is one final version which combines the previous two.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="p">%</span><span class="n">fortran</span>

        <span class="k">Subroutine </span><span class="n">Rescale</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="k">Implicit none</span>
<span class="k">        </span><span class="kt">Integer </span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span>
        <span class="kt">Real</span><span class="o">*</span><span class="mi">8</span> <span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">b</span>
<span class="n">Cf2py</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">,</span><span class="n">out</span><span class="p">,</span><span class="n">overwrite</span><span class="p">)</span> <span class="n">a</span>
        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">n</span>
           <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
             <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">b</span><span class="o">*</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
           <span class="k">end do</span>
<span class="k">        end do</span>
<span class="k">        end</span>
</pre></div>
</div>
<p>The (in,out,overwrite) intent says that if <span class="math notranslate nohighlight">\(a\)</span> is in FORTRAN
ordering we work in place, however if its not we copy it and return
the contents afterwards. This is sort of the best of both worlds.
Note that if you are repeatedly passing large numpy arrays to
fortran code, it is very important to avoiding copying the array by
using (inout) or (in,out,overwrite). Remember though that your
numpy array must use Fortran ordering to avoid the copying.</p>
<p>For more examples and more advanced usage of F2py you should refer
to the f2py webpage <a class="reference external" href="http://cens.ioc.ee/projects/f2py2e/">http://cens.ioc.ee/projects/f2py2e/</a>. The
command line f2py tool which is referred to in the f2py
documentation can be called from the Sage shell using</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">!f2py</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="using_compiled_code_iteractively.html"
                        title="previous chapter">Using Compiled Code Interactively</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="f2py_examples.html"
                        title="next chapter">More Interesting Examples with f2py</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/numerical_sage/f2py.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="f2py_examples.html" title="More Interesting Examples with f2py"
             >next</a> |</li>
        <li class="right" >
          <a href="using_compiled_code_iteractively.html" title="Using Compiled Code Interactively"
             >previous</a> |</li>
  
    
      <a href="../../index.html"><img src="../_static/logo_sagemath_black.svg" height="28" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li class="nav-item nav-item-0"><a href="../index.html">Thematic Tutorials v9.4</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../toctree.html" >Thematic tutorial document tree</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Numerical Computing with Sage</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="using_compiled_code_iteractively.html" >Using Compiled Code Interactively</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">f2py</a></li> 
      </ul>
    </div>
    
    <div class="footer" role="contentinfo">
        &#169; Copyright 2005--2021, The Sage Development Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.1.
    </div>
    <script type="text/javascript">
/*global jQuery, window */
/* Sphinx sidebar toggle.  Putting this code at the end of the body
 * enables the toggle for the live, static, and offline docs.  Note:
 * sage.misc.html.math_parse() eats jQuery's dollar-sign shortcut. */
var jq = jQuery;
jq(document).ready(function () {
    var bar, bod, bg, fg, key, tog, wid_old, wid_new, get_state, set_state;
    bod = jq('div.bodywrapper');
    bar = jq('div.sphinxsidebar');
    tog = jq('<div class="sphinxsidebartoggle"></div>');

    /* The sidebar toggle adapts its height to the bodywrapper height. */
    const resizeObserver = new ResizeObserver(entries => {
        tog.height(bod.height());
    });
    resizeObserver.observe(bod[0]);

    /* Setup and add the toggle. See Sphinx v0.5.1 default.css. */
    fg = jq('div.sphinxsidebar p a').css('color') || 'rgb(152, 219, 204)';
    bg = jq('div.document').css('background-color') || 'rgb(28, 78, 99)';
    wid_old = '230px';
    wid_new = '5px';
    tog.css('background-color', bg)
        .css('border-width', '0px')
        .css('border-right', wid_new + ' ridge ' + bg)
        .css('cursor', 'pointer')
        .css('position', 'absolute')
        .css('left', '-' + wid_new)
        .css('top', '0px')
        .css('width', wid_new);
    bod.css('position', 'relative');
    bod.prepend(tog);

    /* Cookie helpers. */
    key = 'sphinxsidebar=';
    set_state = function (s) {
        var date = new Date();
        /* Expiry in 7 days. */
        date.setTime(date.getTime() + (7 * 24 * 3600 * 1000));
        document.cookie = key + encodeURIComponent(s) + '; expires=' +
            date.toUTCString() + '; path=/';
    };
    get_state = function () {
        var i, c, crumbs = document.cookie.split(';');
        for (i = 0; i < crumbs.length; i += 1) {
            c = crumbs[i].replace(/^\s+/, '');
            if (c.indexOf(key) === 0) {
                return decodeURIComponent(c.substring(key.length, c.length));
            }
        }
        return null;
    };

    /* Event handlers. */
    tog.mouseover(function (ev) {
        tog.css('border-right-color', fg);
    }).mouseout(function (ev) {
        tog.css('border-right-color', bg);
    }).click(function (ev) {
        if (bod.hasClass('wide')) {
            bod.removeClass('wide');
            bod.css('margin-left', wid_old);
            bar.css('width', wid_old);
            bar.show();
            set_state('visible');
        } else {
            set_state('hidden');
            bar.hide();
            bar.css('width', '0px');
            bod.css('margin-left', wid_new);
            bod.addClass('wide');
        }
    });

    /* Hide the normally visible sidebar? */
    if (get_state() === 'hidden') {
        tog.trigger('click');
    } else {
        set_state('visible');
    }
});
    </script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66100-14', 'auto');
  ga('send', 'pageview');
</script>
  </body>
</html>
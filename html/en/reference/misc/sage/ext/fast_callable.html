<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Fast Expression Evaluation &mdash; Sage Reference Manual v7.1: Utilities</title>
    
    <link rel="stylesheet" href="../../../_static/sage.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <script type="text/javascript" src="../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="top" title="Sage Reference Manual v7.1: Utilities" href="../../index.html" />
    <link rel="next" title="Fast Numerical Evaluation" href="fast_eval.html" />
    <link rel="prev" title="Fast and safe weak value dictionary" href="../misc/weak_dict.html" />
    <link rel="icon" href="../../../_static/sageicon.png" type="image/x-icon" />

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="fast_eval.html" title="Fast Numerical Evaluation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../misc/weak_dict.html" title="Fast and safe weak value dictionary"
             accesskey="P">previous</a> |</li>
  
    
      <a href="../../../../index.html"><img src="../../../_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li><a href="../../index.html">Utilities</a> &raquo;</li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="fast-expression-evaluation">
<span id="sage-ext-fast-callable"></span><h1>Fast Expression Evaluation<a class="headerlink" href="#fast-expression-evaluation" title="Permalink to this headline">¶</a></h1>
<span class="target" id="module-sage.ext.fast_callable"></span><p>For many applications such as numerical integration, differential
equation approximation, plotting a 3d surface, optimization problems,
Monte-Carlo simulations, etc., one wishes to pass around and evaluate
a single algebraic expression many, many times at various floating
point values.  Other applications may need to evaluate an expression
many times in interval arithmetic, or in a finite field.  Doing this
via recursive calls over a python representation of the object (even
if Maxima or other outside packages are not involved) is extremely
inefficient.</p>
<p>This module provides a function, <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a>, to
transform such expressions into a form where they can be evaluated
quickly:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">f</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span>
<span class="gp">sage: </span><span class="n">ff</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="gp">sage: </span><span class="n">ff</span><span class="p">(</span><span class="mf">3.5</span><span class="p">)</span>
<span class="go">36.3992167723104</span>
<span class="gp">sage: </span><span class="n">ff</span><span class="p">(</span><span class="n">RIF</span><span class="p">(</span><span class="mf">3.5</span><span class="p">))</span>
<span class="go">36.39921677231038?</span>
</pre></div>
</div>
<p>By default, <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a> only removes some interpretive
overhead from the evaluation, but all of the individual arithmetic
operations are done using standard Sage arithmetic.  This is still a
huge win over sage.calculus, which evidently has a lot of overhead.
Compare the cost of evaluating Wilkinson&#8217;s polynomial (in unexpanded
form) at x=30:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">wilk</span> <span class="o">=</span> <span class="n">prod</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span> <span class="o">..</span> <span class="mi">20</span><span class="p">]);</span> <span class="n">wilk</span>
<span class="go">(x - 1)*(x - 2)*(x - 3)*(x - 4)*(x - 5)*(x - 6)*(x - 7)*(x - 8)*(x - 9)*(x - 10)*(x - 11)*(x - 12)*(x - 13)*(x - 14)*(x - 15)*(x - 16)*(x - 17)*(x - 18)*(x - 19)*(x - 20)</span>
<span class="gp">sage: </span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;wilk.subs(x=30)&#39;</span><span class="p">)</span> <span class="c1"># random, long time</span>
<span class="go">625 loops, best of 3: 1.43 ms per loop</span>
<span class="gp">sage: </span><span class="n">fc_wilk</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">wilk</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="gp">sage: </span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;fc_wilk(30)&#39;</span><span class="p">)</span> <span class="c1"># random, long time</span>
<span class="go">625 loops, best of 3: 9.72 us per loop</span>
</pre></div>
</div>
<p>You can specify a particular domain for the evaluation using
<tt class="docutils literal"><span class="pre">domain=</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fc_wilk_zz</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">wilk</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">)</span>
</pre></div>
</div>
<p>The meaning of domain=D is that each intermediate and final result
is converted to type D.  For instance, the previous example of
<tt class="docutils literal"><span class="pre">sin(x)</span> <span class="pre">+</span> <span class="pre">3*x^2</span></tt> with domain=D would be equivalent to
<tt class="docutils literal"><span class="pre">D(D(sin(D(x)))</span> <span class="pre">+</span> <span class="pre">D(D(3)*D(D(x)^2)))</span></tt>.  (This example also
demonstrates the one exception to the general rule: if an exponent is an
integral constant, then it is not wrapped with D().)</p>
<p>At first glance, this seems like a very bad idea if you want to
compute quickly.  And it is a bad idea, for types where we don&#8217;t
have a special interpreter.  It&#8217;s not too bad of a slowdown, though.
To mitigate the costs, we check whether the value already has
the correct parent before we call D.</p>
<p>We don&#8217;t yet have a special interpreter with domain ZZ, so we can see
how that compares to the generic fc_wilk example above:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;fc_wilk_zz(30)&#39;</span><span class="p">)</span> <span class="c1"># random, long time</span>
<span class="go">625 loops, best of 3: 15.4 us per loop</span>
</pre></div>
</div>
<p>However, for other types, using domain=D will get a large speedup,
because we have special-purpose interpreters for those types.  One
example is RDF.  Since with domain=RDF we know that every single
operation will be floating-point, we can just execute the
floating-point operations directly and skip all the Python object
creations that you would get from actually using RDF objects:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fc_wilk_rdf</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">wilk</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;fc_wilk_rdf(30.0)&#39;</span><span class="p">)</span> <span class="c1"># random, long time</span>
<span class="go">625 loops, best of 3: 7 us per loop</span>
</pre></div>
</div>
<p>The domain does not need to be a Sage type; for instance, domain=float
also works.  (We actually use the same fast interpreter for domain=float
and domain=RDF; the only difference is that when domain=RDF is used,
the return value is an RDF element, and when domain=float is used,
the return value is a Python float.)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fc_wilk_float</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">wilk</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;fc_wilk_float(30.0)&#39;</span><span class="p">)</span> <span class="c1"># random, long time</span>
<span class="go">625 loops, best of 3: 5.04 us per loop</span>
</pre></div>
</div>
<p>We also have support for <tt class="docutils literal"><span class="pre">RR</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fc_wilk_rr</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">wilk</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">RR</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;fc_wilk_rr(30.0)&#39;</span><span class="p">)</span> <span class="c1"># random, long time</span>
<span class="go">625 loops, best of 3: 13 us per loop</span>
</pre></div>
</div>
<p>And support for <tt class="docutils literal"><span class="pre">CDF</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fc_wilk_rr</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">wilk</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">CDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;fc_wilk_rr(30.0)&#39;</span><span class="p">)</span> <span class="c1"># random, long time</span>
<span class="go">625 loops, best of 3: 10.2 us per loop</span>
</pre></div>
</div>
<p>Currently, <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a> can accept two kinds of objects:
polynomials (univariate and multivariate) and symbolic expressions
(elements of the Symbolic Ring).  (This list is likely to grow
significantly in the near future.)  For polynomials, you can omit the
&#8216;vars&#8217; argument; the variables will default to the ring generators (in
the order used when creating the ring).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">K</span><span class="o">.&lt;</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">QQ</span><span class="p">[]</span>
<span class="gp">sage: </span><span class="n">p</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="mi">100</span><span class="o">*</span><span class="n">z</span> <span class="o">+</span> <span class="n">x</span>
<span class="gp">sage: </span><span class="n">fp</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="go">321</span>
</pre></div>
</div>
<p>But you can also specify the variable names to override the default
ordering (you can include extra variable names here, too).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fp</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>For symbolic expressions, you need to specify the variable names, so
that <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a> knows what order to use.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;y,z,x&#39;</span><span class="p">)</span>
<span class="go">(y, z, x)</span>
<span class="gp">sage: </span><span class="n">f</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="mi">100</span><span class="o">*</span><span class="n">z</span> <span class="o">+</span> <span class="n">x</span>
<span class="gp">sage: </span><span class="n">ff</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">ff</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="go">321</span>
</pre></div>
</div>
<p>You can also specify extra variable names:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">ff</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">ff</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="go">341</span>
</pre></div>
</div>
<p>This should be enough for normal use of <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a>; let&#8217;s
discuss some more advanced topics.</p>
<p>Sometimes it may be useful to create a fast version of an expression
without going through symbolic expressions or polynomials; perhaps
because you want to describe to <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a> an expression
with common subexpressions.</p>
<p>Internally, <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a> works in two stages: it constructs
an expression tree from its argument, and then it builds a
fast evaluator from that expression tree.  You can bypass the first phase
by building your own expression tree and passing that directly to
<a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a>, using an <a class="reference internal" href="#sage.ext.fast_callable.ExpressionTreeBuilder" title="sage.ext.fast_callable.ExpressionTreeBuilder"><tt class="xref py py-class docutils literal"><span class="pre">ExpressionTreeBuilder</span></tt></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>An <a class="reference internal" href="#sage.ext.fast_callable.ExpressionTreeBuilder" title="sage.ext.fast_callable.ExpressionTreeBuilder"><tt class="xref py py-class docutils literal"><span class="pre">ExpressionTreeBuilder</span></tt></a> has three interesting methods:
<tt class="xref py py-meth docutils literal"><span class="pre">constant()</span></tt>, <tt class="xref py py-meth docutils literal"><span class="pre">var()</span></tt>, and <tt class="xref py py-meth docutils literal"><span class="pre">call()</span></tt>.
All of these methods return <tt class="xref py py-class docutils literal"><span class="pre">ExpressionTree</span></tt> objects.</p>
<p>The <tt class="xref py py-meth docutils literal"><span class="pre">var()</span></tt> method takes a string, and returns an expression tree
for the corresponding variable.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">y</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">z</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Expression trees support Python&#8217;s numeric operators, so you can easily
build expression trees representing arithmetic expressions.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">//</span><span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="xref py py-meth docutils literal"><span class="pre">constant()</span></tt> method takes a Sage value, and returns an
expression tree representing that value.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">v2</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">3.14159</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">etb</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">1729</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>
</pre></div>
</div>
<p>The <tt class="xref py py-meth docutils literal"><span class="pre">call()</span></tt> method takes a sage/Python function and zero or more
expression trees, and returns an expression tree representing
the function call.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">v3</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">v1</span><span class="o">+</span><span class="n">v2</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">v3</span>
<span class="go">sin(add(add(mul(add(v_0, v_1), add(v_1, v_1)), floordiv(v_1, v_1)), add(mul(3.14159000000000, v_0), mul(1729, v_1))))</span>
</pre></div>
</div>
<p>Many sage/Python built-in functions are specially handled; for instance,
when evaluating an expression involving <tt class="xref py py-func docutils literal"><span class="pre">sin()</span></tt> over <tt class="docutils literal"><span class="pre">RDF</span></tt>,
the C math library function <tt class="xref py py-func docutils literal"><span class="pre">sin()</span></tt> is called.  Arbitrary functions
are allowed, but will be much slower since they will call back to
Python code on every call; for example, the following will work.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="k">def</span> <span class="nf">my_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">e</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">my_sqrt</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span> <span class="n">e</span>
<span class="go">{my_sqrt}(add(mul(add(v_0, v_1), add(v_1, v_1)), floordiv(v_1, v_1)))</span>
<span class="gp">sage: </span><span class="n">fast_callable</span><span class="p">(</span><span class="n">e</span><span class="p">)(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="go">3.60555127546399</span>
</pre></div>
</div>
<p>To provide <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a> for your own class (so that
<tt class="docutils literal"><span class="pre">fast_callable(x)</span></tt> works when <tt class="docutils literal"><span class="pre">x</span></tt> is an instance of your
class), implement a method <tt class="docutils literal"><span class="pre">_fast_callable_(self,</span> <span class="pre">etb)</span></tt> for your class.
This method takes an <a class="reference internal" href="#sage.ext.fast_callable.ExpressionTreeBuilder" title="sage.ext.fast_callable.ExpressionTreeBuilder"><tt class="xref py py-class docutils literal"><span class="pre">ExpressionTreeBuilder</span></tt></a>, and returns an
expression tree built up using the methods described above.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="go">x</span>
<span class="gp">sage: </span><span class="n">f</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="mi">7</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1.4142135623730951</span>
<span class="gp">sage: </span><span class="n">f</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;ipow&#39;, 7), (&#39;load_const&#39;, 1.0), &#39;add&#39;, &#39;sqrt&#39;, &#39;return&#39;]</span>
</pre></div>
</div>
<p>To interpret that last line, we load argument 0 (&#8216;x&#8217; in this case) onto
the stack, push the constant 7.0 onto the stack, call the pow function
(which takes 2 arguments from the stack), push the constant 1.0, add the
top two arguments of the stack, and then call sqrt.</p>
<p>Here we take sin of the first argument and add it to f:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">f</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">x</span><span class="o">^</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">g</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fast_callable</span><span class="p">(</span><span class="n">f</span><span class="o">+</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;ipow&#39;, 7), (&#39;load_const&#39;, 1), &#39;add&#39;, (&#39;py_call&#39;, &lt;function sqrt at ...&gt;, 1), (&#39;load_arg&#39;, 0), (&#39;py_call&#39;, sin, 1), &#39;add&#39;, &#39;return&#39;]</span>
</pre></div>
</div>
<p>AUTHOR:</p>
<ul class="simple">
<li>Carl Witty (2009-02): initial version (heavily inspired by
Robert Bradshaw&#8217;s fast_eval.pyx)</li>
</ul>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p>The following bits of text were written for the module docstring.
They are not true yet, but I hope they will be true someday, at
which point I will move them into the main text.</p>
<p>The final interesting method of <a class="reference internal" href="#sage.ext.fast_callable.ExpressionTreeBuilder" title="sage.ext.fast_callable.ExpressionTreeBuilder"><tt class="xref py py-class docutils literal"><span class="pre">ExpressionTreeBuilder</span></tt></a> is
<a class="reference internal" href="../misc/prandom.html#sage.misc.prandom.choice" title="sage.misc.prandom.choice"><tt class="xref py py-meth docutils literal"><span class="pre">choice()</span></tt></a>.  This produces conditional expressions, like the C
<tt class="docutils literal"><span class="pre">COND</span> <span class="pre">?</span> <span class="pre">T</span> <span class="pre">:</span> <span class="pre">F</span></tt> expression or the Python <tt class="docutils literal"><span class="pre">T</span> <span class="pre">if</span> <span class="pre">COND</span> <span class="pre">else</span> <span class="pre">F</span></tt>.
This lets you define piecewise functions using <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">v4</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">v3</span> <span class="o">&gt;=</span> <span class="n">etb</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
</pre></div>
</div>
<p>The arguments are <tt class="docutils literal"><span class="pre">(COND,</span> <span class="pre">T,</span> <span class="pre">F)</span></tt> (the same order as in C), so the
above means that if <tt class="docutils literal"><span class="pre">v3</span></tt> evaluates to a nonnegative number,
then <tt class="docutils literal"><span class="pre">v4</span></tt> will evaluate to the result of <tt class="docutils literal"><span class="pre">v1</span></tt>;
otherwise, <tt class="docutils literal"><span class="pre">v4</span></tt> will evaluate to the result of <tt class="docutils literal"><span class="pre">v2</span></tt>.</p>
<p>Let&#8217;s see an example where we see that <a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a> does not
evaluate common subexpressions more than once.  We&#8217;ll make a
<a class="reference internal" href="#sage.ext.fast_callable.fast_callable" title="sage.ext.fast_callable.fast_callable"><tt class="xref py py-func docutils literal"><span class="pre">fast_callable()</span></tt></a> expression that gives the result
of 16 iterations of the Mandelbrot function.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">z</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">c</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
<span class="go">....:     z = z*z + c</span>
<span class="gp">sage: </span><span class="n">mand</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">CDF</span><span class="p">)</span>
</pre></div>
</div>
<p>Now <tt class="docutils literal"><span class="pre">ff</span></tt> does 32 complex arithmetic operations on each call
(16 additions and 16 multiplications).  However, if <tt class="docutils literal"><span class="pre">z*z</span></tt> produced
code that evaluated <tt class="docutils literal"><span class="pre">z</span></tt> twice, then this would do many
thousands of arithmetic operations instead.</p>
<p>Note that the handling for common subexpressions only checks whether
expression trees are the same Python object; for instance, the following
code will evaluate <tt class="docutils literal"><span class="pre">x+1</span></tt> twice:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="go">mul(add(v_0, 1), add(v_0, 1))</span>
</pre></div>
</div>
<p>but this code will only evaluate <tt class="docutils literal"><span class="pre">x+1</span></tt> once:</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">v</span><span class="o">*</span><span class="n">v</span>
<span class="go">mul(add(v_0, 1), add(v_0, 1))</span>
</pre></div>
</div>
</div>
<dl class="class">
<dt id="sage.ext.fast_callable.CompilerInstrSpec">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">CompilerInstrSpec</tt><big>(</big><em>n_inputs</em>, <em>n_outputs</em>, <em>parameters</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.CompilerInstrSpec" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>Describes a single instruction to the fast_callable code generator.</p>
<p>An instruction has a number of stack inputs, a number of stack
outputs, and a parameter list describing extra arguments that
must be passed to the InstructionStream.instr method (that end up
as extra words in the code).</p>
<p>The parameter list is a list of strings.  Each string is one of
the following:</p>
<ul class="simple">
<li>&#8216;args&#8217; - The instruction argument refers to an input argument of the
wrapper class; it is just appended to the code.</li>
<li>&#8216;constants&#8217;, &#8216;py_constants&#8217; - The instruction argument is a value; the
value is added to the corresponding list (if it&#8217;s not already there) and
the index is appended to the code.</li>
<li>&#8216;n_inputs&#8217;, &#8216;n_outputs&#8217; - The instruction actually takes a variable
number of inputs or outputs (the n_inputs and n_outputs attributes of
this instruction are ignored). The instruction argument specifies the
number of inputs or outputs (respectively); it is just appended to the
code.</li>
</ul>
</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.Expression">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">Expression</tt><a class="headerlink" href="#sage.ext.fast_callable.Expression" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>Represents an expression for fast_callable.</p>
<p>Supports the standard Python arithmetic operators; if arithmetic
is attempted between an Expression and a non-Expression, the
non-Expression is converted to an expression (using the
__call__ method of the Expression&#8217;s ExpressionTreeBuilder).</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">v_0</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="go">sin(v_0)</span>
<span class="gp">sage: </span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="go">div(add(v_0, 1), sub(v_0, 1))</span>
<span class="gp">sage: </span><span class="n">x</span><span class="o">//</span><span class="mi">5</span>
<span class="go">floordiv(v_0, 5)</span>
<span class="gp">sage: </span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="o">~</span><span class="n">x</span><span class="p">)</span>
<span class="go">neg(abs(inv(v_0)))</span>
</pre></div>
</div>
<dl class="method">
<dt id="sage.ext.fast_callable.Expression.abs">
<tt class="descname">abs</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.Expression.abs" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute the absolute value of an Expression.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">sage: </span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">abs(v_0)</span>
<span class="gp">sage: </span><span class="n">x</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="go">abs(v_0)</span>
<span class="gp">sage: </span><span class="n">x</span><span class="o">.</span><span class="n">__abs__</span><span class="p">()</span>
<span class="go">abs(v_0)</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.ExpressionCall">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">ExpressionCall</tt><a class="headerlink" href="#sage.ext.fast_callable.ExpressionCall" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#sage.ext.fast_callable.Expression" title="sage.ext.fast_callable.Expression"><tt class="xref py py-class docutils literal"><span class="pre">sage.ext.fast_callable.Expression</span></tt></a></p>
<p>An Expression that represents a function call.</p>
<dl class="docutils">
<dt>EXAMPLES:</dt>
<dd>sage: from sage.ext.fast_callable import ExpressionTreeBuilder
sage: etb = ExpressionTreeBuilder(vars=(x,))
sage: type(etb.call(sin, x))
&lt;type &#8216;sage.ext.fast_callable.ExpressionCall&#8217;&gt;</dd>
</dl>
<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionCall.arguments">
<tt class="descname">arguments</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionCall.arguments" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the arguments from this ExpressionCall.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span><span class="p">()</span>
<span class="go">[v_0]</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionCall.function">
<tt class="descname">function</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionCall.function" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the function from this ExpressionCall.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">function</span><span class="p">()</span>
<span class="go">sin</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.ExpressionChoice">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">ExpressionChoice</tt><a class="headerlink" href="#sage.ext.fast_callable.ExpressionChoice" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#sage.ext.fast_callable.Expression" title="sage.ext.fast_callable.Expression"><tt class="xref py py-class docutils literal"><span class="pre">sage.ext.fast_callable.Expression</span></tt></a></p>
<p>A conditional expression.</p>
<p>(It&#8217;s possible to create choice nodes, but they don&#8217;t work yet.)</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">x</span><span class="p">)</span>
<span class="go">(0 if {eq}(v_0, 0) else div(1, v_0))</span>
</pre></div>
</div>
<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionChoice.condition">
<tt class="descname">condition</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionChoice.condition" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the condition of an ExpressionChoice.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">~</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">condition</span><span class="p">()</span>
<span class="go">v_0</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionChoice.if_false">
<tt class="descname">if_false</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionChoice.if_false" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the false branch of an ExpressionChoice.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">~</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">if_false</span><span class="p">()</span>
<span class="go">0</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionChoice.if_true">
<tt class="descname">if_true</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionChoice.if_true" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the true branch of an ExpressionChoice.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">~</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">if_true</span><span class="p">()</span>
<span class="go">inv(v_0)</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.ExpressionConstant">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">ExpressionConstant</tt><a class="headerlink" href="#sage.ext.fast_callable.ExpressionConstant" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#sage.ext.fast_callable.Expression" title="sage.ext.fast_callable.Expression"><tt class="xref py py-class docutils literal"><span class="pre">sage.ext.fast_callable.Expression</span></tt></a></p>
<p>An Expression that represents an arbitrary constant.</p>
<dl class="docutils">
<dt>EXAMPLES:</dt>
<dd>sage: from sage.ext.fast_callable import ExpressionTreeBuilder
sage: etb = ExpressionTreeBuilder(vars=(x,))
sage: type(etb(3))
&lt;type &#8216;sage.ext.fast_callable.ExpressionConstant&#8217;&gt;</dd>
</dl>
<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionConstant.value">
<tt class="descname">value</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionConstant.value" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the constant value of an ExpressionConstant.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
<span class="go">3</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.ExpressionIPow">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">ExpressionIPow</tt><a class="headerlink" href="#sage.ext.fast_callable.ExpressionIPow" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#sage.ext.fast_callable.Expression" title="sage.ext.fast_callable.Expression"><tt class="xref py py-class docutils literal"><span class="pre">sage.ext.fast_callable.Expression</span></tt></a></p>
<p>A power Expression with an integer exponent.</p>
<dl class="docutils">
<dt>EXAMPLES:</dt>
<dd>sage: from sage.ext.fast_callable import ExpressionTreeBuilder
sage: etb = ExpressionTreeBuilder(vars=(x,))
sage: type(etb.var(&#8216;x&#8217;)^17)
&lt;type &#8216;sage.ext.fast_callable.ExpressionIPow&#8217;&gt;</dd>
</dl>
<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionIPow.base">
<tt class="descname">base</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionIPow.base" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the base from this ExpressionIPow.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span><span class="o">^</span><span class="mi">42</span><span class="p">)</span><span class="o">.</span><span class="n">base</span><span class="p">()</span>
<span class="go">33</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionIPow.exponent">
<tt class="descname">exponent</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionIPow.exponent" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the exponent from this ExpressionIPow.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">exponent</span><span class="p">()</span>
<span class="go">-1</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.ExpressionTreeBuilder">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">ExpressionTreeBuilder</tt><a class="headerlink" href="#sage.ext.fast_callable.ExpressionTreeBuilder" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>A class with helper methods for building Expressions.</p>
<p>An instance of this class is passed to _fast_callable_ methods;
you can also instantiate it yourself to create your own expressions
for fast_callable, bypassing _fast_callable_.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span>
<span class="go">mul(add(v_0, 3), 5)</span>
</pre></div>
</div>
<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionTreeBuilder.call">
<tt class="descname">call</tt><big>(</big><em>fn</em>, <em>*args</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionTreeBuilder.call" title="Permalink to this definition">¶</a></dt>
<dd><p>Construct a call node, given a function and a list of arguments.
The arguments will be converted to Expressions using
ExpressionTreeBuilder.__call__.</p>
<p>As a special case, notices if the function is operator.pow and
the second argument is integral, and constructs an ExpressionIPow
instead.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="go">cos(v_0)</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">sin(1)</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">etb</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="go">sin(1)</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">factorial</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">57</span><span class="p">)</span>
<span class="go">{factorial}(add(v_0, 57))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">pow</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">543</span><span class="p">)</span>
<span class="go">ipow(v_0, 543)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionTreeBuilder.choice">
<tt class="descname">choice</tt><big>(</big><em>cond</em>, <em>iftrue</em>, <em>iffalse</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionTreeBuilder.choice" title="Permalink to this definition">¶</a></dt>
<dd><p>Construct a choice node (a conditional expression), given the
condition, and the values for the true and false cases.</p>
<p>(It&#8217;s possible to create choice nodes, but they don&#8217;t work yet.)</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">x</span><span class="p">)</span>
<span class="go">(0 if {eq}(v_0, 0) else div(1, v_0))</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionTreeBuilder.constant">
<tt class="descname">constant</tt><big>(</big><em>c</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionTreeBuilder.constant" title="Permalink to this definition">¶</a></dt>
<dd><p>Turn the argument into an ExpressionConstant, converting it to
our domain if we have one.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
<span class="go">pi</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RealField</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
<span class="go">3.1415926535897932384626433832795028841971693993751058209749</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionTreeBuilder.var">
<tt class="descname">var</tt><big>(</big><em>v</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionTreeBuilder.var" title="Permalink to this definition">¶</a></dt>
<dd><p>Turn the argument into an ExpressionVariable.  Looks it up in
the list of variables.  (Variables are matched by name.)</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;a,b,some_really_long_name&#39;</span><span class="p">)</span>
<span class="go">(a, b, some_really_long_name)</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">polygen</span><span class="p">(</span><span class="n">QQ</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">some_really_long_name</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">some_really_long_name</span><span class="p">)</span>
<span class="go">v_2</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;some_really_long_name&#39;</span><span class="p">)</span>
<span class="go">v_2</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">v_3</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">Variable &#39;y&#39; not found</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.ExpressionVariable">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">ExpressionVariable</tt><a class="headerlink" href="#sage.ext.fast_callable.ExpressionVariable" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#sage.ext.fast_callable.Expression" title="sage.ext.fast_callable.Expression"><tt class="xref py py-class docutils literal"><span class="pre">sage.ext.fast_callable.Expression</span></tt></a></p>
<p>An Expression that represents a variable.</p>
<dl class="docutils">
<dt>EXAMPLES:</dt>
<dd>sage: from sage.ext.fast_callable import ExpressionTreeBuilder
sage: etb = ExpressionTreeBuilder(vars=(x,))
sage: type(etb.var(x))
&lt;type &#8216;sage.ext.fast_callable.ExpressionVariable&#8217;&gt;</dd>
</dl>
<dl class="method">
<dt id="sage.ext.fast_callable.ExpressionVariable.variable_index">
<tt class="descname">variable_index</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.ExpressionVariable.variable_index" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the variable index of an ExpressionVariable.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span>
<span class="gp">sage: </span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">variable_index</span><span class="p">()</span>
<span class="go">0</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.InstructionStream">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">InstructionStream</tt><a class="headerlink" href="#sage.ext.fast_callable.InstructionStream" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>An InstructionStream takes a sequence of instructions (passed in by
a series of method calls) and computes the data structures needed
by the interpreter.  This is the stage where we switch from operating
on Expression trees to a linear representation.  If we had a peephole
optimizer (we don&#8217;t) it would go here.</p>
<p>Currently, this class is not very general; it only works for
interpreters with a fixed set of memory chunks (with fixed names).
Basically, it only works for stack-based expression interpreters.
It should be generalized, so that the interpreter metadata includes
a description of the memory chunks involved and the instruction stream
can handle any interpreter.</p>
<p>Once you&#8217;re done adding instructions, you call get_current() to retrieve
the information needed by the interpreter (as a Python dictionary).</p>
<dl class="method">
<dt id="sage.ext.fast_callable.InstructionStream.current_op_list">
<tt class="descname">current_op_list</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.InstructionStream.current_op_list" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the list of instructions that have been added to this
InstructionStream so far.</p>
<p>It&#8217;s OK to call this, then add more instructions.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.interpreters.wrapper_rdf</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">InstructionStream</span>
<span class="gp">sage: </span><span class="n">instr_stream</span> <span class="o">=</span> <span class="n">InstructionStream</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;load_arg&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;py_call&#39;</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;abs&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">current_op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;py_call&#39;, &lt;built-in function sin&gt;, 1), &#39;abs&#39;, &#39;return&#39;]</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.InstructionStream.get_current">
<tt class="descname">get_current</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.InstructionStream.get_current" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the current state of the InstructionStream, as a dictionary
suitable for passing to a wrapper class.</p>
<p>NOTE: The dictionary includes internal data structures of the
InstructionStream; you must not modify it.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.interpreters.wrapper_rdf</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">InstructionStream</span>
<span class="gp">sage: </span><span class="n">instr_stream</span> <span class="o">=</span> <span class="n">InstructionStream</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span>
<span class="go">{&#39;args&#39;: 1,</span>
<span class="go"> &#39;code&#39;: [],</span>
<span class="go"> &#39;constants&#39;: [],</span>
<span class="go"> &#39;domain&#39;: None,</span>
<span class="go"> &#39;py_constants&#39;: [],</span>
<span class="go"> &#39;stack&#39;: 0}</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;load_arg&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;py_call&#39;</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;abs&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">current_op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;py_call&#39;, &lt;built-in function sin&gt;, 1), &#39;abs&#39;, &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span>
<span class="go">{&#39;args&#39;: 1,</span>
<span class="go"> &#39;code&#39;: [0, 0, 3, 0, 1, 12, 2],</span>
<span class="go"> &#39;constants&#39;: [],</span>
<span class="go"> &#39;domain&#39;: None,</span>
<span class="go"> &#39;py_constants&#39;: [&lt;built-in function sin&gt;],</span>
<span class="go"> &#39;stack&#39;: 1}</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.InstructionStream.get_metadata">
<tt class="descname">get_metadata</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.InstructionStream.get_metadata" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the interpreter metadata being used by the current
InstructionStream.</p>
<p>The code generator sometimes uses this to decide which code
to generate.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.interpreters.wrapper_rdf</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">InstructionStream</span>
<span class="gp">sage: </span><span class="n">instr_stream</span> <span class="o">=</span> <span class="n">InstructionStream</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">md</span> <span class="o">=</span> <span class="n">instr_stream</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
<span class="gp">sage: </span><span class="nb">type</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
<span class="go">&lt;type &#39;sage.ext.fast_callable.InterpreterMetadata&#39;&gt;</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.InstructionStream.has_instr">
<tt class="descname">has_instr</tt><big>(</big><em>opname</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.InstructionStream.has_instr" title="Permalink to this definition">¶</a></dt>
<dd><p>Check whether this InstructionStream knows how to generate code
for a given instruction.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.interpreters.wrapper_rdf</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">InstructionStream</span>
<span class="gp">sage: </span><span class="n">instr_stream</span> <span class="o">=</span> <span class="n">InstructionStream</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">has_instr</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">has_instr</span><span class="p">(</span><span class="s1">&#39;factorial&#39;</span><span class="p">)</span>
<span class="go">False</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">has_instr</span><span class="p">(</span><span class="s1">&#39;abs&#39;</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.InstructionStream.instr">
<tt class="descname">instr</tt><big>(</big><em>opname</em>, <em>*args</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.InstructionStream.instr" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate code in this InstructionStream for the given instruction
and arguments.</p>
<p>The opname is used to look up a CompilerInstrSpec; the
CompilerInstrSpec describes how to interpret the arguments.
(This is documented in the class docstring for CompilerInstrSpec.)</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.interpreters.wrapper_rdf</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">InstructionStream</span>
<span class="gp">sage: </span><span class="n">instr_stream</span> <span class="o">=</span> <span class="n">InstructionStream</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;load_arg&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;sin&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;py_call&#39;</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;abs&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;factorial&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">KeyError</span>: <span class="n">&#39;factorial&#39;</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">current_op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), &#39;sin&#39;, (&#39;py_call&#39;, &lt;built-in function sin&gt;, 1), &#39;abs&#39;, &#39;return&#39;]</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.InstructionStream.load_arg">
<tt class="descname">load_arg</tt><big>(</big><em>n</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.InstructionStream.load_arg" title="Permalink to this definition">¶</a></dt>
<dd><p>Add a &#8216;load_arg&#8217; instruction to this InstructionStream.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.interpreters.wrapper_rdf</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">InstructionStream</span>
<span class="gp">sage: </span><span class="n">instr_stream</span> <span class="o">=</span> <span class="n">InstructionStream</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">load_arg</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">current_op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 5)]</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">load_arg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">current_op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 5), (&#39;load_arg&#39;, 3)]</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.InstructionStream.load_const">
<tt class="descname">load_const</tt><big>(</big><em>c</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.InstructionStream.load_const" title="Permalink to this definition">¶</a></dt>
<dd><p>Add a &#8216;load_const&#8217; instruction to this InstructionStream.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.interpreters.wrapper_rdf</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">InstructionStream</span><span class="p">,</span> <span class="n">op_list</span>
<span class="gp">sage: </span><span class="n">instr_stream</span> <span class="o">=</span> <span class="n">InstructionStream</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">load_const</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">current_op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_const&#39;, 5)]</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">load_const</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">load_const</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">current_op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_const&#39;, 5), (&#39;load_const&#39;, 7), (&#39;load_const&#39;, 5)]</span>
</pre></div>
</div>
<p>Note that constants are shared: even though we load 5 twice, it
only appears once in the constant table.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">get_current</span><span class="p">()[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span>
<span class="go">[5, 7]</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.IntegerPowerFunction">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">IntegerPowerFunction</tt><big>(</big><em>n</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.IntegerPowerFunction" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>This class represents the function x^n for an arbitrary integral
power n.  That is, IntegerPowerFunction(2) is the squaring function;
IntegerPowerFunction(-1) is the reciprocal function.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">IntegerPowerFunction</span>
<span class="gp">sage: </span><span class="n">square</span> <span class="o">=</span> <span class="n">IntegerPowerFunction</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">square</span>
<span class="go">(^2)</span>
<span class="gp">sage: </span><span class="n">square</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
<span class="go">pi^2</span>
<span class="gp">sage: </span><span class="n">square</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
<span class="go">-1</span>
<span class="gp">sage: </span><span class="n">square</span><span class="p">(</span><span class="n">RIF</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;brackets&#39;</span><span class="p">)</span>
<span class="go">&#39;[0.00000000000000000 .. 1.0000000000000000]&#39;</span>
<span class="gp">sage: </span><span class="n">IntegerPowerFunction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="go">(^(-1))</span>
<span class="gp">sage: </span><span class="n">IntegerPowerFunction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)(</span><span class="mi">22</span><span class="o">/</span><span class="mi">7</span><span class="p">)</span>
<span class="go">7/22</span>
<span class="gp">sage: </span><span class="n">v</span> <span class="o">=</span> <span class="n">Integers</span><span class="p">(</span><span class="mi">123456789</span><span class="p">)(</span><span class="mi">54321</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">v</span><span class="o">^</span><span class="mi">9876543210</span>
<span class="go">79745229</span>
<span class="gp">sage: </span><span class="n">IntegerPowerFunction</span><span class="p">(</span><span class="mi">9876543210</span><span class="p">)(</span><span class="n">v</span><span class="p">)</span>
<span class="go">79745229</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.InterpreterMetadata">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">InterpreterMetadata</tt><a class="headerlink" href="#sage.ext.fast_callable.InterpreterMetadata" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>The interpreter metadata for a fast_callable interpreter.  Currently
consists of a dictionary mapping instruction names to
(CompilerInstrSpec, opcode) pairs, a list mapping opcodes to
(instruction name, CompilerInstrSpec) pairs, and a range of exponents
for which the ipow instruction can be used.  This range can be
False (if the ipow instruction should never be used), a pair of
two integers (a,b), if ipow should be used for a&lt;=n&lt;=b, or True,
if ipow should always be used.  When ipow cannot be used, then
we fall back on calling IntegerPowerFunction.</p>
<p>See the class docstring for CompilerInstrSpec for more information.</p>
<p>NOTE: You must not modify the metadata.</p>
<dl class="attribute">
<dt id="sage.ext.fast_callable.InterpreterMetadata.by_opcode">
<tt class="descname">by_opcode</tt><a class="headerlink" href="#sage.ext.fast_callable.InterpreterMetadata.by_opcode" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="attribute">
<dt id="sage.ext.fast_callable.InterpreterMetadata.by_opname">
<tt class="descname">by_opname</tt><a class="headerlink" href="#sage.ext.fast_callable.InterpreterMetadata.by_opname" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="attribute">
<dt id="sage.ext.fast_callable.InterpreterMetadata.ipow_range">
<tt class="descname">ipow_range</tt><a class="headerlink" href="#sage.ext.fast_callable.InterpreterMetadata.ipow_range" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="class">
<dt id="sage.ext.fast_callable.Wrapper">
<em class="property">class </em><tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">Wrapper</tt><a class="headerlink" href="#sage.ext.fast_callable.Wrapper" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>The parent class for all fast_callable wrappers.  Implements shared
behavior (currently only debugging).</p>
<dl class="method">
<dt id="sage.ext.fast_callable.Wrapper.get_orig_args">
<tt class="descname">get_orig_args</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.Wrapper.get_orig_args" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the original arguments used when initializing this
wrapper.</p>
<p>(Probably only useful when writing doctests.)</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fast_callable</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">x</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span><span class="o">.</span><span class="n">get_orig_args</span><span class="p">()</span>
<span class="go">{&#39;args&#39;: 1,</span>
<span class="go"> &#39;code&#39;: [0, 0, 16, 0, 0, 8, 2],</span>
<span class="go"> &#39;constants&#39;: [],</span>
<span class="go"> &#39;domain&#39;: Real Double Field,</span>
<span class="go"> &#39;py_constants&#39;: [],</span>
<span class="go"> &#39;stack&#39;: 2}</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.Wrapper.op_list">
<tt class="descname">op_list</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.Wrapper.op_list" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the list of instructions in this wrapper.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fast_callable</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;load_arg&#39;, 0), &#39;cos&#39;, &#39;mul&#39;, &#39;return&#39;]</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.ext.fast_callable.Wrapper.python_calls">
<tt class="descname">python_calls</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.Wrapper.python_calls" title="Permalink to this definition">¶</a></dt>
<dd><p>List the Python functions that are called in this wrapper.</p>
<p>(Python function calls are slow, so ideally this list would
be empty.  If it is not empty, then perhaps there is an
optimization opportunity where a Sage developer could speed
this up by adding a new instruction to the interpreter.)</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fast_callable</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span><span class="o">.</span><span class="n">python_calls</span><span class="p">()</span>
<span class="go">[]</span>
<span class="gp">sage: </span><span class="n">fast_callable</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">python_calls</span><span class="p">()</span>
<span class="go">[factorial, sin]</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="sage.ext.fast_callable.fast_callable">
<tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">fast_callable</tt><big>(</big><em>x</em>, <em>domain=None</em>, <em>vars=None</em>, <em>_autocompute_vars_for_backward_compatibility_with_deprecated_fast_float_functionality=False</em>, <em>expect_one_var=False</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.fast_callable" title="Permalink to this definition">¶</a></dt>
<dd><p>Given an expression x, compiles it into a form that can be quickly
evaluated, given values for the variables in x.</p>
<p>Currently, x can be an expression object, an element of SR, or a
(univariate or multivariate) polynomial; this list will probably
be extended soon.</p>
<p>By default, x is evaluated the same way that a Python function
would evaluate it &#8211; addition maps to PyNumber_Add, etc.  However,
you can specify domain=D where D is some Sage parent or Python
type; in this case, all arithmetic is done in that domain.  If we
have a special-purpose interpreter for that parent (like RDF or float),
domain=... will trigger the use of that interpreter.</p>
<p>If vars is None and x is a polynomial, then we will use the
generators of parent(x) as the variables; otherwise, vars must be
specified (unless x is a symbolic expression with only one variable,
and expect_one_var is True, in which case we will use that variable).</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="go">x</span>
<span class="gp">sage: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span>
<span class="gp">sage: </span><span class="n">f</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="gp">sage: </span><span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">sin(2) + 12</span>
<span class="gp">sage: </span><span class="n">f</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
<span class="go">12.9092974268257</span>
</pre></div>
</div>
<p>We have special fast interpreters for domain=float and domain=RDF.
(Actually it&#8217;s the same interpreter; only the return type varies.)
Note that the float interpreter is not actually more accurate than
the RDF interpreter; elements of RDF just don&#8217;t display all
their digits. We have special fast interpreter for domain=CDF:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">f_float</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">f_float</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">12.909297426825681</span>
<span class="gp">sage: </span><span class="n">f_rdf</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">f_rdf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">12.909297426825681</span>
<span class="gp">sage: </span><span class="n">f_cdf</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">CDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">f_cdf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">12.909297426825681</span>
<span class="gp">sage: </span><span class="n">f_cdf</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">I</span><span class="p">)</span>
<span class="go">10.40311925062204 + 11.510943740958707*I</span>
<span class="gp">sage: </span><span class="n">f</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="go">sin(2) + 12</span>
<span class="gp">sage: </span><span class="n">K</span><span class="o">.&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">QQ</span><span class="p">[]</span>
<span class="gp">sage: </span><span class="n">p</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">random_element</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="n">p</span>
<span class="go">-x^6 - 12*x^5 + 1/2*x^4 - 1/95*x^3 - 1/2*x^2 - 4</span>
<span class="gp">sage: </span><span class="n">fp</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fp</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;load_const&#39;, -1.0), &#39;mul&#39;, (&#39;load_const&#39;, -12.0), &#39;add&#39;, (&#39;load_arg&#39;, 0), &#39;mul&#39;, (&#39;load_const&#39;, 0.5), &#39;add&#39;, (&#39;load_arg&#39;, 0), &#39;mul&#39;, (&#39;load_const&#39;, -0.010526315789473684), &#39;add&#39;, (&#39;load_arg&#39;, 0), &#39;mul&#39;, (&#39;load_const&#39;, -0.5), &#39;add&#39;, (&#39;load_arg&#39;, 0), &#39;mul&#39;, (&#39;load_arg&#39;, 0), &#39;mul&#39;, (&#39;load_const&#39;, -4.0), &#39;add&#39;, &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fp</span><span class="p">(</span><span class="mf">3.14159</span><span class="p">)</span>
<span class="go">-4594.161823640176</span>
<span class="gp">sage: </span><span class="n">K</span><span class="o">.&lt;</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">QQ</span><span class="p">[]</span>
<span class="gp">sage: </span><span class="n">p</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">random_element</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span> <span class="n">p</span>
<span class="go">-x*y^2 - x*z^2 - 6*x^2 - y^2 - 3*x*z</span>
<span class="gp">sage: </span><span class="n">fp</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fp</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_const&#39;, 0.0), (&#39;load_const&#39;, -3.0), (&#39;load_arg&#39;, 0), (&#39;ipow&#39;, 1), (&#39;load_arg&#39;, 2), (&#39;ipow&#39;, 1), &#39;mul&#39;, &#39;mul&#39;, &#39;add&#39;, (&#39;load_const&#39;, -1.0), (&#39;load_arg&#39;, 0), (&#39;ipow&#39;, 1), (&#39;load_arg&#39;, 1), (&#39;ipow&#39;, 2), &#39;mul&#39;, &#39;mul&#39;, &#39;add&#39;, (&#39;load_const&#39;, -6.0), (&#39;load_arg&#39;, 0), (&#39;ipow&#39;, 2), &#39;mul&#39;, &#39;add&#39;, (&#39;load_const&#39;, -1.0), (&#39;load_arg&#39;, 1), (&#39;ipow&#39;, 2), &#39;mul&#39;, &#39;add&#39;, (&#39;load_const&#39;, -1.0), (&#39;load_arg&#39;, 0), (&#39;ipow&#39;, 1), (&#39;load_arg&#39;, 2), (&#39;ipow&#39;, 2), &#39;mul&#39;, &#39;mul&#39;, &#39;add&#39;, &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fp</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>   <span class="c1"># abs tol 3e-14</span>
<span class="go">-98.00156403362932</span>
<span class="gp">sage: </span><span class="n">symbolic_result</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="n">symbolic_result</span>
<span class="go">-pi^2*e - pi^2 - 3*sqrt(2)*e - 6*e^2 - 2*e</span>
<span class="gp">sage: </span><span class="n">n</span><span class="p">(</span><span class="n">symbolic_result</span><span class="p">)</span>
<span class="go">-98.0015640336293</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">y</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="p">);</span> <span class="n">expr</span>
<span class="go">sin(add(ipow(v_0, 2), v_1))</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="go">0.5514266812416906</span>
</pre></div>
</div>
<p>Check that fast_callable also works for symbolic functions with evaluation
functions:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="k">def</span> <span class="nf">evalf_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span> <span class="k">return</span> <span class="n">parent</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span>
<span class="gp">sage: </span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;x,y&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">f</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">evalf_func</span><span class="o">=</span><span class="n">evalf_func</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="go">f(3, 4)</span>
</pre></div>
</div>
<p>And also when there are complex values involved:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="k">def</span> <span class="nf">evalf_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span> <span class="k">return</span> <span class="n">parent</span><span class="p">(</span><span class="n">I</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">I</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">y</span>
<span class="gp">sage: </span><span class="n">g</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">evalf_func</span><span class="o">=</span><span class="n">evalf_func</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="go">g(3, 4)</span>
<span class="gp">sage: </span><span class="n">fc2</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="nb">complex</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
<span class="gp">sage: </span><span class="n">fc2</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="go">12j</span>
<span class="gp">sage: </span><span class="n">fc3</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
<span class="gp">sage: </span><span class="n">fc3</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
    <span class="o">...</span>
<span class="gr">TypeError</span>: <span class="n">unable to simplify to float approximation</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="sage.ext.fast_callable.function_name">
<tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">function_name</tt><big>(</big><em>fn</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.function_name" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a function, returns a string giving a name for the function.</p>
<p>For functions we recognize, we use our standard opcode name for the
function (so operator.add becomes &#8216;add&#8217;, and sage.all.sin becomes &#8216;sin&#8217;).</p>
<p>For functions we don&#8217;t recognize, we try to come up with a name,
but the name will be wrapped in braces; this is a signal that
we&#8217;ll definitely use a slow Python call to call this function.
(We may use a slow Python call even for functions we do recognize,
if we&#8217;re targeting an interpreter without an opcode for the function.)</p>
<p>Only used when printing Expressions.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">function_name</span>
<span class="gp">sage: </span><span class="n">function_name</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">pow</span><span class="p">)</span>
<span class="go">&#39;pow&#39;</span>
<span class="gp">sage: </span><span class="n">function_name</span><span class="p">(</span><span class="n">cos</span><span class="p">)</span>
<span class="go">&#39;cos&#39;</span>
<span class="gp">sage: </span><span class="n">function_name</span><span class="p">(</span><span class="n">factorial</span><span class="p">)</span>
<span class="go">&#39;{factorial}&#39;</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="sage.ext.fast_callable.generate_code">
<tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">generate_code</tt><big>(</big><em>expr</em>, <em>stream</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.generate_code" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate code from an Expression tree; write the result into an
InstructionStream.</p>
<p>In fast_callable, first we create an Expression, either directly
with an ExpressionTreeBuilder or with _fast_callable_ methods.
Then we optimize the Expression in tree form.  (Unfortunately,
this step is currently missing &#8211; we do no optimizations.)</p>
<p>Then we linearize the Expression into a sequence of instructions,
by walking the Expression and sending the corresponding stack
instructions to an InstructionStream.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">ExpressionTreeBuilder</span><span class="p">,</span> <span class="n">generate_code</span><span class="p">,</span> <span class="n">InstructionStream</span>
<span class="gp">sage: </span><span class="n">etb</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">x</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.interpreters.wrapper_py</span> <span class="kn">import</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">Wrapper_py</span>
<span class="gp">sage: </span><span class="n">instr_stream</span> <span class="o">=</span> <span class="n">InstructionStream</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">generate_code</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">instr_stream</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">v</span> <span class="o">=</span> <span class="n">Wrapper_py</span><span class="p">(</span><span class="n">instr_stream</span><span class="o">.</span><span class="n">get_current</span><span class="p">())</span>
<span class="gp">sage: </span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="go">&lt;type &#39;sage.ext.interpreters.wrapper_py.Wrapper_py&#39;&gt;</span>
<span class="gp">sage: </span><span class="n">v</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="go">8*pi + 56</span>
</pre></div>
</div>
<p>TESTS:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="k">def</span> <span class="nf">my_sin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">sage: </span><span class="k">def</span> <span class="nf">my_norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span>
<span class="gp">sage: </span><span class="k">def</span> <span class="nf">my_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="gp">... </span>      <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;sqrt of negative number&quot;</span>
<span class="gp">... </span>      <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RealField</span><span class="p">(</span><span class="mi">130</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="go">3.1415926535897932384626433832795028842</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">8.2831853071795864769252867665590057684</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="go">3.141592653589793</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">8.283185307179586</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;load_const&#39;, pi), &#39;add&#39;, (&#39;load_arg&#39;, 0), (&#39;load_const&#39;, 1), &#39;add&#39;, &#39;mul&#39;, &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1.8414709848078965</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), &#39;sin&#39;, (&#39;load_arg&#39;, 0), &#39;sqrt&#39;, &#39;add&#39;, &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">sin(1) + 1</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;py_call&#39;, sin, 1), (&#39;load_arg&#39;, 0), (&#39;py_call&#39;, &lt;function sqrt at ...&gt;, 1), &#39;add&#39;, &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">my_sin</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">0.1411200080598672</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">my_sin</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="n">RealField</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">0.14112000805986722210074480281</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;py_call&#39;, &lt;function my_sin at 0x...&gt;, 1), &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">my_sqrt</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">1.7320508075688772</span>
<span class="gp">sage: </span><span class="n">parent</span><span class="p">(</span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="go">Real Double Field</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">sqrt of negative number</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">my_sqrt</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="n">RR</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">1.73205080756888</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">sqrt of negative number</span>
<span class="gp">sage: </span><span class="n">etb2</span> <span class="o">=</span> <span class="n">ExpressionTreeBuilder</span><span class="p">((</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">y</span> <span class="o">=</span> <span class="n">etb2</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">z</span> <span class="o">=</span> <span class="n">etb2</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb2</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">etb2</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">my_norm</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)),</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="go">5.0</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;load_arg&#39;, 1), (&#39;py_call&#39;, &lt;function my_norm at 0x...&gt;, 2), &#39;sqrt&#39;, &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">python_calls</span><span class="p">()</span>
<span class="go">[&lt;function my_norm at 0x...&gt;]</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb2</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">etb2</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">my_norm</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)),</span> <span class="n">domain</span><span class="o">=</span><span class="n">RR</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="go">5.00000000000000</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb2</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">my_norm</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="go">25</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;load_arg&#39;, 1), (&#39;py_call&#39;, &lt;function my_norm at 0x...&gt;, 2), &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mf">3.0</span><span class="n">r</span><span class="p">)</span>
<span class="go">4.0*pi + 12.0</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="go">7</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">no conversion of this rational to integer</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="go">0</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">unable to convert sin(3) to an integer</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="mi">100</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
<span class="go">pi^100</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="mi">100</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">1267650600228229401496703205376</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="mi">100</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RIF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="n">RIF</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
<span class="go">1.2676506002282295?e30</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="mi">100</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;ipow&#39;, 100), &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span>
<span class="go">13780.61233982...</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="mi">100</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RR</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;ipow&#39;, 100), &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span>
<span class="go">13780.6123398224</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;ipow&#39;, -100), &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span>
<span class="go">7.25657159014...e-05</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">),</span> <span class="n">domain</span><span class="o">=</span><span class="n">RR</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span>
<span class="go">0.0000725657159014814</span>
<span class="gp">sage: </span><span class="n">expo</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">32</span>
<span class="gp">sage: </span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">nextabove</span><span class="p">()</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="n">expo</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RDF</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;py_call&#39;, (^4294967296), 1), &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>        <span class="c1"># rel tol 1e-15</span>
<span class="go">1.0000009536747712</span>
<span class="gp">sage: </span><span class="n">RDF</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="o">^</span><span class="n">expo</span>
<span class="go">1.0000009536747712</span>
<span class="gp">sage: </span><span class="n">fc</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">etb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="n">expo</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">RR</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="o">.</span><span class="n">op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), (&#39;py_call&#39;, (^4294967296), 1), &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">fc</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
<span class="go">1.00000095367477</span>
<span class="gp">sage: </span><span class="n">base</span><span class="o">^</span><span class="n">expo</span>
<span class="go">1.00000095367477</span>
</pre></div>
</div>
<p>Make sure we don&#8217;t overflow the stack with highly nested expressions (#11766):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">R</span><span class="o">.&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">CC</span><span class="p">[]</span>
<span class="gp">sage: </span><span class="n">f</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">))</span>
<span class="gp">sage: </span><span class="n">ff</span> <span class="o">=</span> <span class="n">fast_callable</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">f</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="go">2.00000000000000</span>
<span class="gp">sage: </span><span class="n">ff</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="go">2.00000000000000</span>
<span class="gp">sage: </span><span class="n">f</span><span class="p">(</span><span class="mf">0.9</span><span class="p">),</span> <span class="n">ff</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
<span class="go">(90.0000000000000, 90.0000000000000)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="sage.ext.fast_callable.get_builtin_functions">
<tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">get_builtin_functions</tt><big>(</big><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.get_builtin_functions" title="Permalink to this definition">¶</a></dt>
<dd><p>To handle ExpressionCall, we need to map from Sage and
Python functions to opcode names.</p>
<p>This returns a dictionary which is that map.</p>
<p>We delay building builtin_functions to break a circular import
between sage.calculus and this file.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">get_builtin_functions</span>
<span class="gp">sage: </span><span class="n">builtins</span> <span class="o">=</span> <span class="n">get_builtin_functions</span><span class="p">()</span>
<span class="gp">sage: </span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">builtins</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<span class="go">[&#39;abs&#39;, &#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;add&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan&#39;, &#39;atanh&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;cot&#39;, &#39;csc&#39;, &#39;div&#39;, &#39;exp&#39;, &#39;floor&#39;, &#39;floordiv&#39;, &#39;inv&#39;, &#39;log&#39;, &#39;mul&#39;, &#39;neg&#39;, &#39;pow&#39;, &#39;sec&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;sub&#39;, &#39;tan&#39;, &#39;tanh&#39;]</span>
<span class="gp">sage: </span><span class="n">builtins</span><span class="p">[</span><span class="n">sin</span><span class="p">]</span>
<span class="go">&#39;sin&#39;</span>
<span class="gp">sage: </span><span class="n">builtins</span><span class="p">[</span><span class="n">ln</span><span class="p">]</span>
<span class="go">&#39;log&#39;</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="sage.ext.fast_callable.op_list">
<tt class="descclassname">sage.ext.fast_callable.</tt><tt class="descname">op_list</tt><big>(</big><em>args</em>, <em>metadata</em><big>)</big><a class="headerlink" href="#sage.ext.fast_callable.op_list" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a dictionary with the result of calling get_current on an
InstructionStream, and the corresponding interpreter metadata,
return a list of the instructions, in a simple somewhat
human-readable format.</p>
<p>For debugging only.  (That is, it&#8217;s probably not a good idea to
try to programmatically manipulate the result of this function;
the expected use is just to print the returned list to the
screen.)</p>
<p>There&#8217;s probably no reason to call this directly; if you
have a wrapper object, call op_list on it; if you have an
InstructionStream object, call current_op_list on it.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.interpreters.wrapper_rdf</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.ext.fast_callable</span> <span class="kn">import</span> <span class="n">InstructionStream</span><span class="p">,</span> <span class="n">op_list</span>
<span class="gp">sage: </span><span class="n">instr_stream</span> <span class="o">=</span> <span class="n">InstructionStream</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;load_arg&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;abs&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">instr_stream</span><span class="o">.</span><span class="n">current_op_list</span><span class="p">()</span>
<span class="go">[(&#39;load_arg&#39;, 0), &#39;abs&#39;, &#39;return&#39;]</span>
<span class="gp">sage: </span><span class="n">op_list</span><span class="p">(</span><span class="n">instr_stream</span><span class="o">.</span><span class="n">get_current</span><span class="p">(),</span> <span class="n">metadata</span><span class="p">)</span>
<span class="go">[(&#39;load_arg&#39;, 0), &#39;abs&#39;, &#39;return&#39;]</span>
</pre></div>
</div>
</dd></dl>

</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h4>Previous topic</h4>
            <p class="topless"><a href="../misc/weak_dict.html"
                                  title="previous chapter">Fast and safe weak value dictionary</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="fast_eval.html"
                                  title="next chapter">Fast Numerical Evaluation</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../_sources/sage/ext/fast_callable.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../search.html" method="get">
                <input type="text" name="q" size="18" />
               <!-- The shading of the "Go" button should be consistent -->
               <!-- with the colour of the header and footer. See the file -->
               <!-- doc/common/themes/sage/theme.conf for colours used by -->
               <!-- the Sage theme. -->
                <input type="submit" style="background-color: #B8B9F6" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="fast_eval.html" title="Fast Numerical Evaluation"
             >next</a> |</li>
        <li class="right" >
          <a href="../misc/weak_dict.html" title="Fast and safe weak value dictionary"
             >previous</a> |</li>
  
    
      <a href="../../../../index.html"><img src="../../../_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li><a href="../../index.html">Utilities</a> &raquo;</li>
 
      </ul>
    </div>
    
    <div class="footer">
        &copy; Copyright 2005--2016, The Sage Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
    <script type="text/javascript">
/*global jQuery, window */
/* Sphinx sidebar toggle.  Putting this code at the end of the body
 * enables the toggle for the live, static, and offline docs.  Note:
 * sage.misc.html.math_parse() eats jQuery's dollar-sign shortcut. */
var jq = jQuery;
jq(document).ready(function () {
    var bar, bod, bg, fg, key, tog, wid_old, wid_new, resize, get_state, set_state;
    bod = jq('div.bodywrapper');
    bar = jq('div.sphinxsidebar');
    tog = jq('<div class="sphinxsidebartoggle"></div>');

    /* Delayed resize helper.  Not perfect but good enough. */
    resize = function () {
        setTimeout(function () {
            tog.height(bod.height());
        }, 100);
    };
    jq(window).resize(function () {
        resize();
    });

    /* Setup and add the toggle. See Sphinx v0.5.1 default.css. */
    fg = jq('div.sphinxsidebar p a').css('color') || 'rgb(152, 219, 204)';
    bg = jq('div.document').css('background-color') || 'rgb(28, 78, 99)';
    wid_old = '230px';
    wid_new = '5px';
    tog.css('background-color', bg)
        .css('border-width', '0px')
        .css('border-right', wid_new + ' ridge ' + bg)
        .css('cursor', 'pointer')
        .css('position', 'absolute')
        .css('left', '-' + wid_new)
        .css('top', '0px')
        .css('width', wid_new);
    bod.css('position', 'relative');
    bod.prepend(tog);
    resize();

    /* Cookie helpers. */
    key = 'sphinxsidebar=';
    set_state = function (s) {
        var date = new Date();
        /* Expiry in 7 days. */
        date.setTime(date.getTime() + (7 * 24 * 3600 * 1000));
        document.cookie = key + encodeURIComponent(s) + '; expires=' +
            date.toUTCString() + '; path=/';
    };
    get_state = function () {
        var i, c, crumbs = document.cookie.split(';');
        for (i = 0; i < crumbs.length; i += 1) {
            c = crumbs[i].replace(/^\s+/, '');
            if (c.indexOf(key) === 0) {
                return decodeURIComponent(c.substring(key.length, c.length));
            }
        }
        return null;
    };

    /* Event handlers. */
    tog.mouseover(function (ev) {
        tog.css('border-right-color', fg);
    }).mouseout(function (ev) {
        tog.css('border-right-color', bg);
    }).click(function (ev) {
        if (bod.hasClass('wide')) {
            bod.removeClass('wide');
            bod.css('margin-left', wid_old);
            bar.css('width', wid_old);
            bar.show();
            set_state('visible');
        } else {
            set_state('hidden');
            bar.hide();
            bar.css('width', '0px');
            bod.css('margin-left', wid_new);
            bod.addClass('wide');
        }
        resize();
    });

    /* Hide the normally visible sidebar? */
    if (get_state() === 'hidden') {
        tog.trigger('click');
    } else {
        set_state('visible');
    }
});
    </script>
  </body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Factory for cached representations &mdash; Sage Reference Manual v7.1: Basic Structures</title>
    
    <link rel="stylesheet" href="../../../_static/sage.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <script type="text/javascript" src="../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="top" title="Sage Reference Manual v7.1: Basic Structures" href="../../index.html" />
    <link rel="next" title="Dynamic classes" href="dynamic_class.html" />
    <link rel="prev" title="Unique Representation" href="unique_representation.html" />
    <link rel="icon" href="../../../_static/sageicon.png" type="image/x-icon" />

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dynamic_class.html" title="Dynamic classes"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="unique_representation.html" title="Unique Representation"
             accesskey="P">previous</a> |</li>
  
    
      <a href="../../../../index.html"><img src="../../../_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li><a href="../../index.html">Basic Structures</a> &raquo;</li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="factory-for-cached-representations">
<span id="sage-structure-factory"></span><h1>Factory for cached representations<a class="headerlink" href="#factory-for-cached-representations" title="Permalink to this headline">¶</a></h1>
<span class="target" id="module-sage.structure.factory"></span><div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="unique_representation.html#module-sage.structure.unique_representation" title="sage.structure.unique_representation"><tt class="xref py py-mod docutils literal"><span class="pre">sage.structure.unique_representation</span></tt></a></p>
</div>
<p>Using a <a class="reference internal" href="#sage.structure.factory.UniqueFactory" title="sage.structure.factory.UniqueFactory"><tt class="xref py py-class docutils literal"><span class="pre">UniqueFactory</span></tt></a> is one way of implementing a <em>cached
representation behaviour</em>. In spite of its name, using a
<a class="reference internal" href="#sage.structure.factory.UniqueFactory" title="sage.structure.factory.UniqueFactory"><tt class="xref py py-class docutils literal"><span class="pre">UniqueFactory</span></tt></a> is not enough to ensure the <em>unique representation
behaviour</em>. See <a class="reference internal" href="unique_representation.html#module-sage.structure.unique_representation" title="sage.structure.unique_representation"><tt class="xref py py-mod docutils literal"><span class="pre">unique_representation</span></tt></a> for a
detailed explanation.</p>
<p>With a <a class="reference internal" href="#sage.structure.factory.UniqueFactory" title="sage.structure.factory.UniqueFactory"><tt class="xref py py-class docutils literal"><span class="pre">UniqueFactory</span></tt></a>, one can preprocess the given arguments. There
is special support for specifying a subset of the arguments that serve as the
unique key, so that still <em>all</em> given arguments are used to create a new
instance, but only the specified subset is used to look up in the
cache. Typically, this is used to construct objects that accept an optional
<tt class="docutils literal"><span class="pre">check=[True|False]</span></tt> argument, but whose result should be unique
regardless of said optional argument. (This use case should be handled with
care, though: Any checking which isn&#8217;t done in the <tt class="docutils literal"><span class="pre">create_key</span></tt> or
<tt class="docutils literal"><span class="pre">create_key_and_extra_args</span></tt> method will be done only when a new object is
generated, but not when a cached object is retrieved from cache.
Consequently, if the factory is once called with <tt class="docutils literal"><span class="pre">check=False</span></tt>, a
subsequent call with <tt class="docutils literal"><span class="pre">check=True</span></tt> cannot be expected to perform all checks
unless these checks are all in the <tt class="docutils literal"><span class="pre">create_key</span></tt> or
<tt class="docutils literal"><span class="pre">create_key_and_extra_args</span></tt> method.)</p>
<p>For a class derived from
<a class="reference internal" href="unique_representation.html#sage.structure.unique_representation.CachedRepresentation" title="sage.structure.unique_representation.CachedRepresentation"><tt class="xref py py-class docutils literal"><span class="pre">CachedRepresentation</span></tt></a>, argument
preprocessing can be obtained by providing a custom static <tt class="docutils literal"><span class="pre">__classcall__</span></tt>
or <tt class="docutils literal"><span class="pre">__classcall_private__</span></tt> method, but this seems less transparent. When
argument preprocessing is not needed or the preprocess is not very
sophisticated, then generally
<a class="reference internal" href="unique_representation.html#sage.structure.unique_representation.CachedRepresentation" title="sage.structure.unique_representation.CachedRepresentation"><tt class="xref py py-class docutils literal"><span class="pre">CachedRepresentation</span></tt></a> is much
easier to use than a factory.</p>
<p>AUTHORS:</p>
<ul class="simple">
<li>Robert Bradshaw (2008): initial version.</li>
<li>Simon King (2013): extended documentation.</li>
<li>Julian Rueth (2014-05-09): use <tt class="docutils literal"><span class="pre">_cache_key</span></tt> if parameters are unhashable</li>
</ul>
<dl class="class">
<dt id="sage.structure.factory.UniqueFactory">
<em class="property">class </em><tt class="descclassname">sage.structure.factory.</tt><tt class="descname">UniqueFactory</tt><a class="headerlink" href="#sage.structure.factory.UniqueFactory" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="sage_object.html#sage.structure.sage_object.SageObject" title="sage.structure.sage_object.SageObject"><tt class="xref py py-class docutils literal"><span class="pre">sage.structure.sage_object.SageObject</span></tt></a></p>
<p>This class is intended to make it easy to cache objects.</p>
<p>It is based on the idea that the object is uniquely defined by a set of
defining data (the key). There is also the possibility of some
non-defining data (extra args) which will be used in initial creation,
but not affect the caching.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This class only provides <em>cached representation behaviour</em>. Hence,
using <a class="reference internal" href="#sage.structure.factory.UniqueFactory" title="sage.structure.factory.UniqueFactory"><tt class="xref py py-class docutils literal"><span class="pre">UniqueFactory</span></tt></a>, it is still possible to create distinct
objects that evaluate equal. Unique representation behaviour can be
added, for example, by additionally inheriting from
<a class="reference external" href="../../../misc/sage/misc/fast_methods.html#sage.misc.fast_methods.WithEqualityById" title="(in Sage Reference Manual: Utilities v7.1)"><tt class="xref py py-class docutils literal"><span class="pre">sage.misc.fast_methods.WithEqualityById</span></tt></a>.</p>
</div>
<p>The objects created are cached (using weakrefs) based on their key and
returned directly rather than re-created if requested again. Pickling is
taken care of by the factory, and will return the same object for the same
version of Sage, and distinct (but hopefully equal) objects for different
versions of Sage.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The objects returned by a <a class="reference internal" href="#sage.structure.factory.UniqueFactory" title="sage.structure.factory.UniqueFactory"><tt class="xref py py-class docutils literal"><span class="pre">UniqueFactory</span></tt></a> must be instances of
new style classes (hence, they must be instances of <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt>)
that must not only allow a weak reference, but must accept general
attribute assignment. Otherwise, pickling won&#8217;t work.</p>
</div>
<p>USAGE:</p>
<p>A <em>unique factory</em> provides a way to create objects from parameters
(the type of these objects can depend on the parameters, and is often
determined only at runtime) and to cache them by a certain key
derived from these parameters, so that when the factory is being
called again with the same parameters (or just with parameters which
yield the same key), the object is being returned from cache rather
than constructed anew.</p>
<p>An implementation of a unique factory consists of a factory class and
an instance of this factory class.</p>
<p>The factory class has to be a class inheriting from <tt class="docutils literal"><span class="pre">UniqueFactory</span></tt>.
Typically it only needs to implement <a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_key" title="sage.structure.factory.UniqueFactory.create_key"><tt class="xref py py-meth docutils literal"><span class="pre">create_key()</span></tt></a> (a method that
creates a key from the given parameters, under which key the object
will be stored in the cache) and <a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_object" title="sage.structure.factory.UniqueFactory.create_object"><tt class="xref py py-meth docutils literal"><span class="pre">create_object()</span></tt></a> (a method that
returns the actual object from the key). Sometimes, one would also
implement <a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_key_and_extra_args" title="sage.structure.factory.UniqueFactory.create_key_and_extra_args"><tt class="xref py py-meth docutils literal"><span class="pre">create_key_and_extra_args()</span></tt></a> (this differs from
<a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_key" title="sage.structure.factory.UniqueFactory.create_key"><tt class="xref py py-meth docutils literal"><span class="pre">create_key()</span></tt></a> in allowing to also create some additional
arguments from the given parameters, which arguments then get passed
to <a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_object" title="sage.structure.factory.UniqueFactory.create_object"><tt class="xref py py-meth docutils literal"><span class="pre">create_object()</span></tt></a> and thus can have an effect on the initial
creation of the object, but do <em>not</em> affect the key) or
<a class="reference internal" href="#sage.structure.factory.UniqueFactory.other_keys" title="sage.structure.factory.UniqueFactory.other_keys"><tt class="xref py py-meth docutils literal"><span class="pre">other_keys()</span></tt></a>. Other methods are not supposed to be overloaded.</p>
<p>The factory class itself cannot be called to create objects. Instead,
an instance of the factory class has to be created first. For
technical reasons, this instance has to be provided with a name that
allows Sage to find its definition. Specifically, the name of the
factory instance (or the full path to it, if it is not in the global
namespace) has to be passed to the factory class as a string variable.
So, if our factory class has been called <tt class="docutils literal"><span class="pre">A</span></tt> and is located in
<tt class="docutils literal"><span class="pre">sage/spam/battletoads.py</span></tt>, then we need to define an instance (say,
<tt class="docutils literal"><span class="pre">B</span></tt>) of <tt class="docutils literal"><span class="pre">A</span></tt> by writing <tt class="docutils literal"><span class="pre">B</span> <span class="pre">=</span> <span class="pre">A(&quot;sage.spam.battletoads.B&quot;)</span></tt>
(or <tt class="docutils literal"><span class="pre">B</span> <span class="pre">=</span> <span class="pre">A(&quot;B&quot;)</span></tt> if this <tt class="docutils literal"><span class="pre">B</span></tt> will be imported into global
namespace). This instance can then be used to create objects (by
calling <tt class="docutils literal"><span class="pre">B(*parameters)</span></tt>).</p>
<p>Notice that the objects created by the factory don&#8217;t inherit from the
factory class. They <em>do</em> know about the factory that created them (this
information, along with the keys under which this factory caches them,
is stored in the <tt class="docutils literal"><span class="pre">_factory_data</span></tt> attributes of the objects), but not
via inheritance.</p>
<p>EXAMPLES:</p>
<p>The below examples are rather artificial and illustrate particular
aspects. For a &#8220;real-life&#8221; usage case of <tt class="docutils literal"><span class="pre">UniqueFactory</span></tt>, see
the finite field factory in <a class="reference external" href="../../../finite_rings/sage/rings/finite_rings/finite_field_constructor.html#module-sage.rings.finite_rings.finite_field_constructor" title="(in Sage Reference Manual: Finite Rings v7.1)"><tt class="xref py py-mod docutils literal"><span class="pre">sage.rings.finite_rings.finite_field_constructor</span></tt></a>.</p>
<p>In many cases, a factory class is implemented by providing the two
methods <a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_key" title="sage.structure.factory.UniqueFactory.create_key"><tt class="xref py py-meth docutils literal"><span class="pre">create_key()</span></tt></a> and <a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_object" title="sage.structure.factory.UniqueFactory.create_object"><tt class="xref py py-meth docutils literal"><span class="pre">create_object()</span></tt></a>. In our example,
we want to demonstrate how to use &#8220;extra arguments&#8221; to choose a specific
implementation, with preference given to an instance found in the cache,
even if its implementation is different. Hence, we implement
<a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_key_and_extra_args" title="sage.structure.factory.UniqueFactory.create_key_and_extra_args"><tt class="xref py py-meth docutils literal"><span class="pre">create_key_and_extra_args()</span></tt></a> rather than <a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_key" title="sage.structure.factory.UniqueFactory.create_key"><tt class="xref py py-meth docutils literal"><span class="pre">create_key()</span></tt></a>, putting
the chosen implementation into the extra arguments. Then, in the
<a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_object" title="sage.structure.factory.UniqueFactory.create_object"><tt class="xref py py-meth docutils literal"><span class="pre">create_object()</span></tt></a> method, we create and return instances of the
specified implementation.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.factory</span> <span class="kn">import</span> <span class="n">UniqueFactory</span>
<span class="gp">sage: </span><span class="k">class</span> <span class="nc">MyFactory</span><span class="p">(</span><span class="n">UniqueFactory</span><span class="p">):</span>
<span class="go">....:     def create_key_and_extra_args(self, *args, **kwds):</span>
<span class="go">....:         return args, {&#39;impl&#39;:kwds.get(&#39;impl&#39;, None)}</span>
<span class="go">....:     def create_object(self, version, key, **extra_args):</span>
<span class="go">....:         impl = extra_args[&#39;impl&#39;]</span>
<span class="go">....:         if impl==&#39;C&#39;:</span>
<span class="go">....:             return C(*key)</span>
<span class="go">....:         if impl==&#39;D&#39;:</span>
<span class="go">....:             return D(*key)</span>
<span class="go">....:         return E(*key)</span>
<span class="go">....:</span>
</pre></div>
</div>
<p>Now we can create a factory instance. It is supposed to be found under the
name <tt class="docutils literal"><span class="pre">&quot;F&quot;</span></tt> in the <tt class="docutils literal"><span class="pre">&quot;__main__&quot;</span></tt> module. Note that in an interactive
session, <tt class="docutils literal"><span class="pre">F</span></tt> would automatically be in the <tt class="docutils literal"><span class="pre">__main__</span></tt> module. Hence,
the second and third of the following four lines are only needed in
doctests.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">F</span> <span class="o">=</span> <span class="n">MyFactory</span><span class="p">(</span><span class="s2">&quot;__main__.F&quot;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="kn">import</span> <span class="nn">__main__</span>
<span class="gp">sage: </span><span class="n">__main__</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>
<span class="gp">sage: </span><span class="n">loads</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="ow">is</span> <span class="n">F</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Now we create three classes <tt class="docutils literal"><span class="pre">C</span></tt>, <tt class="docutils literal"><span class="pre">D</span></tt> and <tt class="docutils literal"><span class="pre">E</span></tt>. The first is a Cython
extension-type class that does not allow weak references nor attribute
assignment. The second is a Python class that is not derived from
<tt class="xref py py-class docutils literal"><span class="pre">object</span></tt>. The third allows attribute assignment and is derived
from <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">cython</span><span class="p">(</span><span class="s2">&quot;cdef class C: pass&quot;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="k">class</span> <span class="nc">D</span><span class="p">:</span>
<span class="go">....:     def __init__(self, *args):</span>
<span class="go">....:         self.t = args</span>
<span class="go">....:     def __repr__(self):</span>
<span class="go">....:         return &quot;D%s&quot;%repr(self.t)</span>
<span class="go">....:</span>
<span class="gp">sage: </span><span class="k">class</span> <span class="nc">E</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span> <span class="k">pass</span>
</pre></div>
</div>
<p>Again, being in a doctest, we need to put the class <tt class="docutils literal"><span class="pre">D</span></tt> into the
<tt class="docutils literal"><span class="pre">__main__</span></tt> module, so that Python can find it:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">import</span> <span class="nn">__main__</span>
<span class="gp">sage: </span><span class="n">__main__</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
</pre></div>
</div>
<p>It is impossible to create an instance of <tt class="docutils literal"><span class="pre">C</span></tt> with our factory, since it
does not allow weak references:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">F</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">cannot create weak reference to &#39;....C&#39; object</span>
</pre></div>
</div>
<p>Let us try again, with a Cython class that does allow weak
references. Now, creation of an instance using the factory works:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">cython</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;cdef class C:</span>
<span class="go">....:     cdef __weakref__</span>
<span class="go">....: &#39;&#39;&#39;)</span>
<span class="go">....:</span>
<span class="gp">sage: </span><span class="n">c</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>The cache is used when calling the factory again&#8212;even if it is suggested
to use a different implementation. This is because the implementation is
only considered an &#8220;extra argument&#8221; that does not count for the key.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">c</span> <span class="ow">is</span> <span class="n">F</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">F</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">F</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>However, pickling and unpickling does not use the cache. This is because
the factory has tried to assign an attribute to the instance that provides
information on the key used to create the instance, but failed:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">loads</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="ow">is</span> <span class="n">c</span>
<span class="go">False</span>
<span class="gp">sage: </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;_factory_data&#39;</span><span class="p">)</span>
<span class="go">False</span>
</pre></div>
</div>
<p>We have already seen that our factory will only take the requested
implementation into account if the arguments used as key have not been
used yet. So, we use other arguments to create an instance of class
<tt class="docutils literal"><span class="pre">D</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">d</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>The factory only knows about the pickling protocol used by new style
classes. Hence, again, pickling and unpickling fails to use the cache,
even though the &#8220;factory data&#8221; are now available:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">loads</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="ow">is</span> <span class="n">d</span>
<span class="go">False</span>
<span class="gp">sage: </span><span class="n">d</span><span class="o">.</span><span class="n">_factory_data</span>
<span class="go">(&lt;class &#39;__main__.MyFactory&#39;&gt;, (...), (2,), {&#39;impl&#39;: &#39;D&#39;})</span>
</pre></div>
</div>
<p>Only when we have a new style class that can be weak referenced and allows
for attribute assignment, everything works:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">e</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">sage: </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">sage: </span><span class="n">loads</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="ow">is</span> <span class="n">e</span>
<span class="go">True</span>
<span class="gp">sage: </span><span class="n">e</span><span class="o">.</span><span class="n">_factory_data</span>
<span class="go">(&lt;class &#39;__main__.MyFactory&#39;&gt;, (...), (3,), {&#39;impl&#39;: None})</span>
</pre></div>
</div>
<dl class="method">
<dt id="sage.structure.factory.UniqueFactory.create_key">
<tt class="descname">create_key</tt><big>(</big><em>*args</em>, <em>**kwds</em><big>)</big><a class="headerlink" href="#sage.structure.factory.UniqueFactory.create_key" title="Permalink to this definition">¶</a></dt>
<dd><p>Given the parameters (arguments and keywords), create a key
that uniquely determines this object.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.test_factory</span> <span class="kn">import</span> <span class="n">test_factory</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="o">.</span><span class="n">create_key</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="go">(1, 2)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.structure.factory.UniqueFactory.create_key_and_extra_args">
<tt class="descname">create_key_and_extra_args</tt><big>(</big><em>*args</em>, <em>**kwds</em><big>)</big><a class="headerlink" href="#sage.structure.factory.UniqueFactory.create_key_and_extra_args" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a tuple containing the key (uniquely defining data)
and any extra arguments (empty by default).</p>
<p>Defaults to <a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_key" title="sage.structure.factory.UniqueFactory.create_key"><tt class="xref py py-meth docutils literal"><span class="pre">create_key()</span></tt></a>.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.test_factory</span> <span class="kn">import</span> <span class="n">test_factory</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="o">.</span><span class="n">create_key_and_extra_args</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="go">((1, 2), {})</span>
<span class="gp">sage: </span><span class="n">GF</span><span class="o">.</span><span class="n">create_key_and_extra_args</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="go">((3, (&#39;x&#39;,), None, &#39;modn&#39;, &quot;{&#39;foo&#39;: &#39;value&#39;}&quot;, 3, 1, True), {&#39;foo&#39;: &#39;value&#39;})</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.structure.factory.UniqueFactory.create_object">
<tt class="descname">create_object</tt><big>(</big><em>version</em>, <em>key</em>, <em>**extra_args</em><big>)</big><a class="headerlink" href="#sage.structure.factory.UniqueFactory.create_object" title="Permalink to this definition">¶</a></dt>
<dd><p>Create the object from the key and extra arguments. This is only
called if the object was not found in the cache.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.test_factory</span> <span class="kn">import</span> <span class="n">test_factory</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="go">Making object (1, 2, 3)</span>
<span class="go">&lt;sage.structure.test_factory.A instance at ...&gt;</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="go">Making object (&#39;a&#39;,)</span>
<span class="go">&lt;sage.structure.test_factory.A instance at ...&gt;</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># NOT called again</span>
<span class="go">&lt;sage.structure.test_factory.A instance at ...&gt;</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.structure.factory.UniqueFactory.get_object">
<tt class="descname">get_object</tt><big>(</big><em>version</em>, <em>key</em>, <em>extra_args</em><big>)</big><a class="headerlink" href="#sage.structure.factory.UniqueFactory.get_object" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the object corresponding to <tt class="docutils literal"><span class="pre">key</span></tt>, creating it with
<tt class="docutils literal"><span class="pre">extra_args</span></tt> if necessary (for example, it isn&#8217;t in the cache
or it is unpickling from an older version of Sage).</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.test_factory</span> <span class="kn">import</span> <span class="n">test_factory</span>
<span class="gp">sage: </span><span class="n">a</span> <span class="o">=</span> <span class="n">test_factory</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{});</span> <span class="n">a</span>
<span class="go">Making object a</span>
<span class="go">&lt;sage.structure.test_factory.A instance at ...&gt;</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">is</span> <span class="n">test_factory</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="go">True</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">is</span> <span class="n">test_factory</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mf">3.1</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="go">Making object a</span>
<span class="go">False</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">is</span> <span class="n">test_factory</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="go">Making object b</span>
<span class="go">False</span>
</pre></div>
</div>
<p>TESTS:</p>
<p>Check that <a class="reference external" href="http://trac.sagemath.org/16317">trac ticket #16317</a> has been fixed, i.e., caching works for
unhashable objects:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">K</span><span class="o">.&lt;</span><span class="n">u</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Qq</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="p">{})</span>  <span class="ow">is</span> <span class="n">test_factory</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="p">{})</span>
<span class="go">Making object (1 + O(2^20), &#39;c&#39;)</span>
<span class="go">True</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.structure.factory.UniqueFactory.get_version">
<tt class="descname">get_version</tt><big>(</big><em>sage_version</em><big>)</big><a class="headerlink" href="#sage.structure.factory.UniqueFactory.get_version" title="Permalink to this definition">¶</a></dt>
<dd><p>This is provided to allow more or less granular control over
pickle versioning. Objects pickled in the same version of Sage
will unpickle to the same rather than simply equal objects. This
can provide significant gains as arithmetic must be performed on
objects with identical parents. However, if there has been an
incompatible change (e.g. in element representation) we want the
version number to change so coercion is forced between the two
parents.</p>
<p>Defaults to the Sage version that is passed in, but coarser
granularity can be provided.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.test_factory</span> <span class="kn">import</span> <span class="n">test_factory</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="o">.</span><span class="n">get_version</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="go">(3, 1, 0)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.structure.factory.UniqueFactory.other_keys">
<tt class="descname">other_keys</tt><big>(</big><em>key</em>, <em>obj</em><big>)</big><a class="headerlink" href="#sage.structure.factory.UniqueFactory.other_keys" title="Permalink to this definition">¶</a></dt>
<dd><p>Sometimes during object creation, certain defaults are chosen which
may result in a new (more specific) key. This allows the more specific
key to be regarded as equivalent to the original key returned by
<a class="reference internal" href="#sage.structure.factory.UniqueFactory.create_key" title="sage.structure.factory.UniqueFactory.create_key"><tt class="xref py py-meth docutils literal"><span class="pre">create_key()</span></tt></a> for the purpose of lookup in the cache, and is used
for pickling.</p>
<p>EXAMPLES:</p>
<p>The <tt class="docutils literal"><span class="pre">GF</span></tt> factory used to have a custom <a class="reference internal" href="#sage.structure.factory.UniqueFactory.other_keys" title="sage.structure.factory.UniqueFactory.other_keys"><tt class="xref py py-meth docutils literal"><span class="pre">other_keys()</span></tt></a>
method, but this was removed in <a class="reference external" href="http://trac.sagemath.org/16934">trac ticket #16934</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">GF</span><span class="o">.</span><span class="n">create_key_and_extra_args</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">);</span> <span class="n">key</span>
<span class="go">(27, (&#39;k&#39;,), x^3 + 2*x + 1, &#39;givaro&#39;, &#39;{}&#39;, 3, 3, True)</span>
<span class="gp">sage: </span><span class="n">K</span> <span class="o">=</span> <span class="n">GF</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span> <span class="n">K</span>
<span class="go">Finite Field in k of size 3^3</span>
<span class="gp">sage: </span><span class="n">GF</span><span class="o">.</span><span class="n">other_keys</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
<span class="go">[]</span>

<span class="gp">sage: </span><span class="n">K</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="mi">7</span><span class="o">^</span><span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">loads</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">K</span><span class="p">))</span> <span class="ow">is</span> <span class="n">K</span>
<span class="go">True</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="sage.structure.factory.UniqueFactory.reduce_data">
<tt class="descname">reduce_data</tt><big>(</big><em>obj</em><big>)</big><a class="headerlink" href="#sage.structure.factory.UniqueFactory.reduce_data" title="Permalink to this definition">¶</a></dt>
<dd><p>The results of this function can be returned from
<tt class="xref py py-meth docutils literal"><span class="pre">__reduce__()</span></tt>. This is here so the factory internals can
change without having to re-write <tt class="xref py py-meth docutils literal"><span class="pre">__reduce__()</span></tt> methods
that use it.</p>
<p>EXAMPLE:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">V</span> <span class="o">=</span> <span class="n">FreeModule</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">factory</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">FreeModule</span><span class="o">.</span><span class="n">reduce_data</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">factory</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="go">Ambient free module of rank 5 over the principal ideal domain Integer Ring</span>
<span class="gp">sage: </span><span class="n">factory</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="n">V</span>
<span class="go">True</span>

<span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.test_factory</span> <span class="kn">import</span> <span class="n">test_factory</span>
<span class="gp">sage: </span><span class="n">a</span> <span class="o">=</span> <span class="n">test_factory</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">Making object (1, 2)</span>
<span class="gp">sage: </span><span class="n">test_factory</span><span class="o">.</span><span class="n">reduce_data</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="go">(&lt;built-in function generic_factory_unpickle&gt;,</span>
<span class="go"> (&lt;class &#39;sage.structure.test_factory.UniqueFactoryTester&#39;&gt;,</span>
<span class="go">  (...),</span>
<span class="go">  (1, 2),</span>
<span class="go">  {}))</span>
</pre></div>
</div>
<p>Note that the ellipsis <tt class="docutils literal"><span class="pre">(...)</span></tt> here stands for the Sage
version.</p>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="sage.structure.factory.generic_factory_reduce">
<tt class="descclassname">sage.structure.factory.</tt><tt class="descname">generic_factory_reduce</tt><big>(</big><em>self</em>, <em>proto</em><big>)</big><a class="headerlink" href="#sage.structure.factory.generic_factory_reduce" title="Permalink to this definition">¶</a></dt>
<dd><p>Used to provide a <tt class="docutils literal"><span class="pre">__reduce__</span></tt> method if one does not already exist.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">V</span> <span class="o">=</span> <span class="n">QQ</span><span class="o">^</span><span class="mi">6</span>
<span class="gp">sage: </span><span class="n">sage</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">generic_factory_reduce</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">V</span><span class="o">.</span><span class="n">__reduce_ex__</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="sage.structure.factory.generic_factory_unpickle">
<tt class="descclassname">sage.structure.factory.</tt><tt class="descname">generic_factory_unpickle</tt><big>(</big><em>factory</em>, <em>*args</em><big>)</big><a class="headerlink" href="#sage.structure.factory.generic_factory_unpickle" title="Permalink to this definition">¶</a></dt>
<dd><p>Method used for unpickling the object.</p>
<p>The unpickling mechanism needs a plain Python function to call.
It takes a factory as the first argument, passes the rest of the
arguments onto the factory&#8217;s <a class="reference internal" href="#sage.structure.factory.UniqueFactory.get_object" title="sage.structure.factory.UniqueFactory.get_object"><tt class="xref py py-meth docutils literal"><span class="pre">UniqueFactory.get_object()</span></tt></a> method.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">V</span> <span class="o">=</span> <span class="n">FreeModule</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">func</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">FreeModule</span><span class="o">.</span><span class="n">reduce_data</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">func</span> <span class="ow">is</span> <span class="n">sage</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">generic_factory_unpickle</span>
<span class="go">True</span>
<span class="gp">sage: </span><span class="n">sage</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">generic_factory_unpickle</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="n">V</span>
<span class="go">True</span>
</pre></div>
</div>
<p>TESTS:</p>
<p>The following was enabled in <a class="reference external" href="http://trac.sagemath.org/16349">trac ticket #16349</a>. Suppose we have defined
(somewhere in the library of an old Sage version) a unique factory; in our
example below, it returns polynomial rings. Now suppose that we want to
replace the factory by something else, say, a class that provides the
unique parent behaviour using
<a class="reference internal" href="unique_representation.html#sage.structure.unique_representation.UniqueRepresentation" title="sage.structure.unique_representation.UniqueRepresentation"><tt class="xref py py-class docutils literal"><span class="pre">UniqueRepresentation</span></tt></a>. We
show here how to make it possible to unpickle a pickle created with the
factory, automatically turning it into an instance of the new class.</p>
<p>First, we create the factory. In a doctest, it is needed to explicitly put
it into <tt class="docutils literal"><span class="pre">__main__</span></tt>, so that it can be located when pickling. Also, it is
needed that we work with a new-style class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.factory</span> <span class="kn">import</span> <span class="n">UniqueFactory</span>
<span class="gp">sage: </span><span class="kn">import</span> <span class="nn">__main__</span>
<span class="gp">sage: </span><span class="k">class</span> <span class="nc">OldStuff</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="go">....:     def __init__(self, n, **extras):</span>
<span class="go">....:         self.n = n</span>
<span class="go">....:     def __repr__(self):</span>
<span class="go">....:         return &quot;Rotten old thing of level {}&quot;.format(self.n)</span>
<span class="gp">sage: </span><span class="n">__main__</span><span class="o">.</span><span class="n">OldStuff</span> <span class="o">=</span> <span class="n">OldStuff</span>
<span class="gp">sage: </span><span class="k">class</span> <span class="nc">MyFactory</span><span class="p">(</span><span class="n">UniqueFactory</span><span class="p">):</span>
<span class="go">....:     def create_object(self, version, key, **extras):</span>
<span class="go">....:         return OldStuff(key[0])</span>
<span class="go">....:     def create_key(self, *args):</span>
<span class="go">....:         return args</span>
<span class="gp">sage: </span><span class="n">F</span> <span class="o">=</span> <span class="n">MyFactory</span><span class="p">(</span><span class="s1">&#39;__main__.F&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">__main__</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>
<span class="gp">sage: </span><span class="n">a</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="n">a</span>
<span class="go">Rotten old thing of level 3</span>
<span class="gp">sage: </span><span class="n">loads</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="ow">is</span> <span class="n">a</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Now, we create a pickle (the string returned by <tt class="docutils literal"><span class="pre">dumps(a)</span></tt>):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">s</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>We create a new class, derived from
<a class="reference internal" href="unique_representation.html#sage.structure.unique_representation.UniqueRepresentation" title="sage.structure.unique_representation.UniqueRepresentation"><tt class="xref py py-class docutils literal"><span class="pre">UniqueRepresentation</span></tt></a>, that
shall replace the old factory. In particular, the class has to have the
same name as the old factory, and has to be put into the same module
(here: <tt class="docutils literal"><span class="pre">__main__</span></tt>). We turn it into a sub-class of the old class, but
this is just to save the effort of writing a new init method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.unique_representation</span> <span class="kn">import</span> <span class="n">UniqueRepresentation</span>
<span class="gp">sage: </span><span class="k">class</span> <span class="nc">F</span><span class="p">(</span><span class="n">UniqueRepresentation</span><span class="p">,</span> <span class="n">OldStuff</span><span class="p">):</span>
<span class="go">....:     def __repr__(self):</span>
<span class="go">....:         return &quot;Shiny new thing of level {}&quot;.format(self.n)</span>
<span class="gp">sage: </span><span class="n">__main__</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>
</pre></div>
</div>
<p>The old pickle correctly unpickles as an instance of the new class, which
is of course different from the instance of the old class, but exhibits
unique object behaviour as well:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">b</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">b</span>
<span class="go">Shiny new thing of level 3</span>
<span class="gp">sage: </span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
<span class="go">False</span>
<span class="gp">sage: </span><span class="n">loads</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="ow">is</span> <span class="n">b</span>
<span class="go">True</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="sage.structure.factory.lookup_global">
<tt class="descclassname">sage.structure.factory.</tt><tt class="descname">lookup_global</tt><big>(</big><em>name</em><big>)</big><a class="headerlink" href="#sage.structure.factory.lookup_global" title="Permalink to this definition">¶</a></dt>
<dd><p>Used in unpickling the factory itself.</p>
<p>EXAMPLES:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.factory</span> <span class="kn">import</span> <span class="n">lookup_global</span>
<span class="gp">sage: </span><span class="n">lookup_global</span><span class="p">(</span><span class="s1">&#39;ZZ&#39;</span><span class="p">)</span>
<span class="go">Integer Ring</span>
<span class="gp">sage: </span><span class="n">lookup_global</span><span class="p">(</span><span class="s1">&#39;sage.rings.all.ZZ&#39;</span><span class="p">)</span>
<span class="go">Integer Ring</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="sage.structure.factory.register_factory_unpickle">
<tt class="descclassname">sage.structure.factory.</tt><tt class="descname">register_factory_unpickle</tt><big>(</big><em>name</em>, <em>callable</em><big>)</big><a class="headerlink" href="#sage.structure.factory.register_factory_unpickle" title="Permalink to this definition">¶</a></dt>
<dd><p>Register a callable to handle the unpickling from an old
<a class="reference internal" href="#sage.structure.factory.UniqueFactory" title="sage.structure.factory.UniqueFactory"><tt class="xref py py-class docutils literal"><span class="pre">UniqueFactory</span></tt></a> object.</p>
<p><a class="reference internal" href="#sage.structure.factory.UniqueFactory" title="sage.structure.factory.UniqueFactory"><tt class="xref py py-class docutils literal"><span class="pre">UniqueFactory</span></tt></a> pickles use a global name through
<a class="reference internal" href="#sage.structure.factory.generic_factory_unpickle" title="sage.structure.factory.generic_factory_unpickle"><tt class="xref py py-func docutils literal"><span class="pre">generic_factory_unpickle()</span></tt></a>, so the usual
<a class="reference internal" href="sage_object.html#sage.structure.sage_object.register_unpickle_override" title="sage.structure.sage_object.register_unpickle_override"><tt class="xref py py-func docutils literal"><span class="pre">register_unpickle_override()</span></tt></a>
cannot be used here.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="#sage.structure.factory.generic_factory_unpickle" title="sage.structure.factory.generic_factory_unpickle"><tt class="xref py py-func docutils literal"><span class="pre">generic_factory_unpickle()</span></tt></a></p>
</div>
<p>TESTS:</p>
<p>This is similar to the example given in
<a class="reference internal" href="#sage.structure.factory.generic_factory_unpickle" title="sage.structure.factory.generic_factory_unpickle"><tt class="xref py py-func docutils literal"><span class="pre">generic_factory_unpickle()</span></tt></a>, but here we will use a function to
explicitly return a polynomial ring.</p>
<p>First, we create the factory. In a doctest, it is needed to explicitly put
it into <tt class="docutils literal"><span class="pre">__main__</span></tt>, so that it can be located when pickling. Also, it is
needed that we work with a new-style class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="kn">from</span> <span class="nn">sage.structure.factory</span> <span class="kn">import</span> <span class="n">UniqueFactory</span><span class="p">,</span> <span class="n">register_factory_unpickle</span>
<span class="gp">sage: </span><span class="kn">import</span> <span class="nn">__main__</span>
<span class="gp">sage: </span><span class="k">class</span> <span class="nc">OldStuff</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="go">....:     def __init__(self, n, **extras):</span>
<span class="go">....:         self.n = n</span>
<span class="go">....:     def __repr__(self):</span>
<span class="go">....:         return &quot;Rotten old thing of level {}&quot;.format(self.n)</span>
<span class="gp">sage: </span><span class="n">__main__</span><span class="o">.</span><span class="n">OldStuff</span> <span class="o">=</span> <span class="n">OldStuff</span>
<span class="gp">sage: </span><span class="k">class</span> <span class="nc">MyFactory</span><span class="p">(</span><span class="n">UniqueFactory</span><span class="p">):</span>
<span class="go">....:     def create_object(self, version, key, **extras):</span>
<span class="go">....:         return OldStuff(key[0])</span>
<span class="go">....:     def create_key(self, *args):</span>
<span class="go">....:         return args</span>
<span class="gp">sage: </span><span class="n">G</span> <span class="o">=</span> <span class="n">MyFactory</span><span class="p">(</span><span class="s1">&#39;__main__.G&#39;</span><span class="p">)</span>
<span class="gp">sage: </span><span class="n">__main__</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>
<span class="gp">sage: </span><span class="n">a</span> <span class="o">=</span> <span class="n">G</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="n">a</span>
<span class="go">Rotten old thing of level 3</span>
<span class="gp">sage: </span><span class="n">loads</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="ow">is</span> <span class="n">a</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Now, we create a pickle (the string returned by <tt class="docutils literal"><span class="pre">dumps(a)</span></tt>):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">s</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>We create the function which will handle the unpickling:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
<span class="go">....:     return PolynomialRing(QQ, n, &#39;x&#39;)</span>
<span class="gp">sage: </span><span class="n">register_factory_unpickle</span><span class="p">(</span><span class="s1">&#39;__main__.G&#39;</span><span class="p">,</span> <span class="n">foo</span><span class="p">)</span>
</pre></div>
</div>
<p>The old pickle correctly unpickles as an explicit polynomial ring:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">sage: </span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="go">Multivariate Polynomial Ring in x0, x1, x2 over Rational Field</span>
</pre></div>
</div>
</dd></dl>

</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h4>Previous topic</h4>
            <p class="topless"><a href="unique_representation.html"
                                  title="previous chapter">Unique Representation</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="dynamic_class.html"
                                  title="next chapter">Dynamic classes</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../_sources/sage/structure/factory.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../search.html" method="get">
                <input type="text" name="q" size="18" />
               <!-- The shading of the "Go" button should be consistent -->
               <!-- with the colour of the header and footer. See the file -->
               <!-- doc/common/themes/sage/theme.conf for colours used by -->
               <!-- the Sage theme. -->
                <input type="submit" style="background-color: #B8B9F6" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dynamic_class.html" title="Dynamic classes"
             >next</a> |</li>
        <li class="right" >
          <a href="unique_representation.html" title="Unique Representation"
             >previous</a> |</li>
  
    
      <a href="../../../../index.html"><img src="../../../_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li><a href="../../index.html">Basic Structures</a> &raquo;</li>
 
      </ul>
    </div>
    
    <div class="footer">
        &copy; Copyright 2005--2016, The Sage Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
    <script type="text/javascript">
/*global jQuery, window */
/* Sphinx sidebar toggle.  Putting this code at the end of the body
 * enables the toggle for the live, static, and offline docs.  Note:
 * sage.misc.html.math_parse() eats jQuery's dollar-sign shortcut. */
var jq = jQuery;
jq(document).ready(function () {
    var bar, bod, bg, fg, key, tog, wid_old, wid_new, resize, get_state, set_state;
    bod = jq('div.bodywrapper');
    bar = jq('div.sphinxsidebar');
    tog = jq('<div class="sphinxsidebartoggle"></div>');

    /* Delayed resize helper.  Not perfect but good enough. */
    resize = function () {
        setTimeout(function () {
            tog.height(bod.height());
        }, 100);
    };
    jq(window).resize(function () {
        resize();
    });

    /* Setup and add the toggle. See Sphinx v0.5.1 default.css. */
    fg = jq('div.sphinxsidebar p a').css('color') || 'rgb(152, 219, 204)';
    bg = jq('div.document').css('background-color') || 'rgb(28, 78, 99)';
    wid_old = '230px';
    wid_new = '5px';
    tog.css('background-color', bg)
        .css('border-width', '0px')
        .css('border-right', wid_new + ' ridge ' + bg)
        .css('cursor', 'pointer')
        .css('position', 'absolute')
        .css('left', '-' + wid_new)
        .css('top', '0px')
        .css('width', wid_new);
    bod.css('position', 'relative');
    bod.prepend(tog);
    resize();

    /* Cookie helpers. */
    key = 'sphinxsidebar=';
    set_state = function (s) {
        var date = new Date();
        /* Expiry in 7 days. */
        date.setTime(date.getTime() + (7 * 24 * 3600 * 1000));
        document.cookie = key + encodeURIComponent(s) + '; expires=' +
            date.toUTCString() + '; path=/';
    };
    get_state = function () {
        var i, c, crumbs = document.cookie.split(';');
        for (i = 0; i < crumbs.length; i += 1) {
            c = crumbs[i].replace(/^\s+/, '');
            if (c.indexOf(key) === 0) {
                return decodeURIComponent(c.substring(key.length, c.length));
            }
        }
        return null;
    };

    /* Event handlers. */
    tog.mouseover(function (ev) {
        tog.css('border-right-color', fg);
    }).mouseout(function (ev) {
        tog.css('border-right-color', bg);
    }).click(function (ev) {
        if (bod.hasClass('wide')) {
            bod.removeClass('wide');
            bod.css('margin-left', wid_old);
            bar.css('width', wid_old);
            bar.show();
            set_state('visible');
        } else {
            set_state('hidden');
            bar.hide();
            bar.css('width', '0px');
            bod.css('margin-left', wid_new);
            bod.addClass('wide');
        }
        resize();
    });

    /* Hide the normally visible sidebar? */
    if (get_state() === 'hidden') {
        tog.trigger('click');
    } else {
        set_state('visible');
    }
});
    </script>
  </body>
</html>